# Log Analyzer 配置文件模板
# 复制此文件为 config.yaml 并填写实际环境信息

# 服务器配置
server:
  host: "0.0.0.0"
  port: 8000

# 数据库配置（可选）
database:
  # 可以配置SQLite、PostgreSQL等
  # type: "sqlite"
  # path: "data/analyzer.db"

# 任务配置
tasks:
  # 示例: 三个应用的错误日志分析
  - name: "Apps_Error_Analysis"
    source:
      name: "multi"  # 使用 MultiSource 插件
      params:
        sources:
          # ========== 需要配置的实际环境信息 ==========
          # dispatcher 应用错误日志
          - type: "docker"
            container_name: "YOUR_DISPATCHER_CONTAINER_NAME"  # 替换为实际容器名
            hours_ago: 24  # 分析最近24小时
            label: "dispatcher"
          
          # agent-python 应用错误日志
          - type: "docker"
            container_name: "YOUR_AGENT_PYTHON_CONTAINER_NAME"  # 替换为实际容器名
            hours_ago: 24
            label: "agent-python"
          
          # mcp-server 应用错误日志
          - type: "docker"
            container_name: "YOUR_MCP_SERVER_CONTAINER_NAME"  # 替换为实际容器名
            hours_ago: 24
            label: "mcp-server"
          # ============================================
        
        # 可选：定义调用关系（帮助大模型理解应用间关系）
        call_chain:
          - from: "dispatcher"
            to: "agent-python"
            protocol: "HTTP SSE"
          - from: "agent-python"
            to: "mcp-server"
            protocol: "MCP"
    
    analyzer:
      name: "langgraph"
      params:
        mode: "sequential"  # 顺序分析，保持时间线上下文
        concurrency: 3
        # ========== 需要配置的实际环境信息 ==========
        # 使用本地 litellm 网关或LLM API
        base_url: "http://YOUR_LLM_SERVER_IP:PORT/v1"  # 替换为实际LLM服务地址
        api_key: "YOUR_API_KEY"  # 替换为实际API密钥
        model_name: "YOUR_MODEL_NAME"  # 替换为实际模型名称
        # ============================================
        # 增强的提示词（包含错误关联分析和修复建议）
        prompts:
          analyze_log_chunk: |
            # 错误日志分析任务
            
            **分析时间**: {current_time}
            **任务**: 对以下错误日志进行深度分析
            
            ## 数据格式说明
            每条日志格式: [时间戳] [应用名称] 错误内容
            
            ## 分析要求
            1. **错误识别**: 识别所有错误、异常、警告
            2. **错误分类**: 自动分类为：数据库错误、网络错误、内存错误、业务错误等
            3. **严重性评估**: 评估每个错误的严重程度（Critical/High/Medium/Low）
            4. **应用标识**: 识别错误来自哪个应用
            
            ## 输出格式
            - 如果**未发现任何错误**，请仅回复单词 "<NONE>"
            - 如果发现错误，请按以下格式输出：
            
            ```
            ### 错误摘要
            [用1-2句话概括核心错误]
            
            ### 详细分析
            - **应用名称**: [应用名称]
            - **错误类型**: [分类]
            - **严重程度**: [Critical/High/Medium/Low]
            - **错误消息**: [核心错误消息]
            - **时间**: [错误发生时间]
            ```
            
            ## 待分析日志片段
            {log_chunk}
          
          summarize_analyses: |
            # 多应用错误日志汇总分析
            
            **汇总时间**: {current_time}
            **任务**: 将多个应用的错误分析结果整合为执行摘要
            
            ## 应用架构信息
            - dispatcher (端口8000): 调度器服务，接收用户请求，调用 agent-python
            - agent-python (端口8003): Python智能体服务，处理业务逻辑，调用 mcp-server
            - mcp-server (端口8004): MCP协议服务器，提供工具和能力服务
            - 调用关系: dispatcher → agent-python (HTTP SSE) → mcp-server (MCP协议)
            
            ## 汇总要求
            1. **错误分类汇总**: 按错误类型分组（数据库错误、网络错误、内存错误等）
            2. **时间维度分析**: 按时间段统计错误数量，识别错误高峰时段
            3. **应用维度分析**: 按应用分组统计错误，识别哪个应用错误最多
            4. **错误关联分析**（重要）:
               - 分析不同应用之间的错误关联
               - 识别错误传播链（哪个应用的错误导致其他应用错误）
               - 推断根因（哪个应用是问题的根源）
               - 结合调用关系分析
            5. **错误根因自动修复建议**（重要）:
               - 针对每个根因错误，给出具体的修复建议
               - 修复建议应该是可执行的、具体的
               - 包括：检查项、配置调整、代码优化、资源扩容等
            
            ## 输出格式
            请使用 Markdown 格式，包含以下章节：
            - 📊 整体评估
            - ⏰ 时间维度分析
            - 📱 应用维度分析
            - 🔗 错误关联分析（包含错误传播链和根因推断）
            - 🔧 错误根因自动修复建议（针对每个根因给出具体建议）
            - 💡 总结与建议
            
            ## 各应用错误分析结果
            {analyses}
    
    sinks:
      - name: "database"      # 存入数据库
      - name: "file"          # 保存到本地文件
        params:
          output_path: "reports/three_apps_error_{{timestamp}}.md"
      # ========== 需要配置的实际环境信息（如果使用MinIO） ==========
      - name: "minio"         # 上传到 MinIO（长期归档）
        params:
          endpoint: "YOUR_MINIO_ENDPOINT"  # 替换为实际MinIO地址，如 "localhost:9000"
          access_key: "YOUR_MINIO_ACCESS_KEY"  # 替换为实际访问密钥
          secret_key: "YOUR_MINIO_SECRET_KEY"  # 替换为实际秘密密钥
          bucket_name: "YOUR_BUCKET_NAME"  # 替换为实际存储桶名称
          object_prefix: "three-apps-error-reports/"
          secure: false  # 如果使用HTTPS，改为 true
      # ============================================================

  # 示例: 单应用文件日志分析
  - name: "File_Log_Analysis"
    source:
      name: "file"
      params:
        file_path: "logs/app.log"
        encoding: "utf-8"
    
    analyzer:
      name: "langgraph"
      params:
        mode: "concurrent"
        concurrency: 5
        # ========== 需要配置的实际环境信息 ==========
        base_url: "http://YOUR_LLM_SERVER_IP:PORT/v1"
        api_key: "YOUR_API_KEY"
        model_name: "YOUR_MODEL_NAME"
        # ============================================
    
    sinks:
      - name: "file"
        params:
          output_path: "reports/file_analysis_{{timestamp}}.md"

  # 示例: 快速检查最近10分钟的错误（可通过API动态指定时间）
  - name: "Quick_Check_10min"
    source:
      name: "multi"
      params:
        sources:
          - type: "docker"
            container_name: "YOUR_DISPATCHER_CONTAINER_NAME"  # 替换为实际容器名
            minutes_ago: 10
            label: "dispatcher"
          - type: "docker"
            container_name: "YOUR_AGENT_PYTHON_CONTAINER_NAME"  # 替换为实际容器名
            minutes_ago: 10
            label: "agent-python"
          - type: "docker"
            container_name: "YOUR_MCP_SERVER_CONTAINER_NAME"  # 替换为实际容器名
            minutes_ago: 10
            label: "mcp-server"
    
    analyzer:
      name: "langgraph"
      params:
        mode: "sequential"
        concurrency: 3
        # ========== 需要配置的实际环境信息 ==========
        base_url: "http://YOUR_LLM_SERVER_IP:PORT/v1"
        api_key: "YOUR_API_KEY"
        model_name: "YOUR_MODEL_NAME"
        # ============================================
    
    sinks:
      - name: "file"
        params:
          output_path: "reports/quick_check_{{timestamp}}.md"
