<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>åº”ç”¨æ—¥å¿—åˆ†æé¢æ¿</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --bg: #f8fafc;
      --card: #ffffff;
      --border: #e2e8f0;
      --text: #0f172a;
      --muted: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
    }
    body { font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); }
    header { background: var(--primary); color: #fff; padding: 14px 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    header h1 { margin: 0; font-size: 20px; }
    header button { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
    header button:hover { background: rgba(255,255,255,0.3); }
    main { padding: 16px 20px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.04); }
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px; }
    .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; text-align: center; }
    .stat-value { font-size: 28px; font-weight: 700; color: var(--primary); margin: 8px 0; }
    .stat-label { font-size: 14px; color: var(--muted); }
    label { display: inline-block; width: 120px; font-weight: 600; color: var(--muted); }
    input, select { padding: 8px 10px; margin: 6px 0; width: 260px; border: 1px solid var(--border); border-radius: 6px; background: #fff; }
    button { padding: 8px 14px; margin-top: 8px; cursor: pointer; background: var(--primary); color: #fff; border: none; border-radius: 6px; font-weight: 600; }
    button:hover { opacity: 0.92; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    pre { background: #0f172a; color: #e2e8f0; padding: 12px; border-radius: 8px; max-height: 400px; overflow: auto; font-size: 13px; }
    .row { display: flex; flex-wrap: wrap; gap: 12px; }
    .col { flex: 1 1 340px; min-width: 300px; }
    small { color: var(--muted); }
    .muted { color: var(--muted); }
    .status { display: inline-block; padding: 4px 8px; border-radius: 6px; background: #e2e8f0; }
    .status.running { background: #dbeafe; color: #1e40af; }
    .status.completed { background: #d1fae5; color: #065f46; }
    .status.failed { background: #fee2e2; color: #991b1b; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin: 6px 0; }
    .chip { padding: 6px 10px; background: #e5edff; color: #1d4ed8; border-radius: 999px; cursor: pointer; border: 1px solid #c7d7ff; font-size: 13px; }
    .chip:hover { background: #d7e5ff; }
    .inline { display: inline-flex; align-items: center; gap: 8px; }
    .report-item { padding: 10px; margin: 6px 0; background: #f8fafc; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: all 0.2s; }
    .report-item:hover { background: #e5edff; border-color: var(--primary); }
    .report-item.active { background: #dbeafe; border-color: var(--primary); }
    .report-item-title { font-weight: 600; color: var(--text); margin-bottom: 4px; }
    .report-item-meta { font-size: 12px; color: var(--muted); }
    .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin: 8px 0; }
    .progress-fill { height: 100%; background: var(--primary); transition: width 0.3s; }
    .notification { position: fixed; top: 20px; right: 20px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 300px; animation: slideIn 0.3s; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .notification.success { border-left: 4px solid var(--success); }
    .notification.error { border-left: 4px solid var(--danger); }
    .markdown-content { 
      background: #fff; 
      padding: 24px; 
      border-radius: 8px; 
      max-height: 600px; 
      overflow-y: auto; 
      line-height: 1.8;
      font-size: 15px;
      color: #1f2937;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4 { 
      margin-top: 28px; 
      margin-bottom: 16px; 
      color: var(--text);
      font-weight: 700;
      line-height: 1.4;
    }
    .markdown-content h1 { 
      font-size: 28px; 
      border-bottom: 3px solid var(--primary); 
      padding-bottom: 12px;
      margin-top: 0;
    }
    .markdown-content h2 { 
      font-size: 24px;
      border-bottom: 2px solid var(--border);
      padding-bottom: 8px;
    }
    .markdown-content h3 { 
      font-size: 20px;
      color: #374151;
    }
    .markdown-content h4 {
      font-size: 18px;
      color: #4b5563;
    }
    .markdown-content p {
      margin: 12px 0;
      line-height: 1.8;
    }
    .markdown-content code { 
      background: #f1f5f9; 
      padding: 3px 8px; 
      border-radius: 4px; 
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace; 
      font-size: 14px;
      color: #e11d48;
    }
    .markdown-content pre { 
      background: #1e293b; 
      color: #e2e8f0; 
      padding: 16px; 
      border-radius: 8px; 
      overflow-x: auto;
      margin: 16px 0;
      line-height: 1.6;
      border-left: 4px solid var(--primary);
    }
    .markdown-content pre code { 
      background: transparent; 
      padding: 0;
      color: #e2e8f0;
      font-size: 14px;
    }
    .markdown-content ul, .markdown-content ol { 
      margin: 16px 0; 
      padding-left: 32px;
      line-height: 1.8;
    }
    .markdown-content li { 
      margin: 8px 0;
      line-height: 1.8;
    }
    .markdown-content blockquote { 
      border-left: 4px solid var(--primary); 
      padding: 12px 20px;
      margin: 16px 0; 
      color: #64748b;
      background: #f8fafc;
      border-radius: 4px;
      font-style: italic;
    }
    .markdown-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
    }
    .markdown-content table th,
    .markdown-content table td {
      border: 1px solid var(--border);
      padding: 10px 12px;
      text-align: left;
    }
    .markdown-content table th {
      background: #f8fafc;
      font-weight: 600;
    }
    .markdown-content hr {
      border: none;
      border-top: 2px solid var(--border);
      margin: 24px 0;
    }
    .markdown-content strong {
      font-weight: 700;
      color: #111827;
    }
    .markdown-content em {
      font-style: italic;
      color: #4b5563;
    }
    .quick-actions { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }
    .quick-btn { padding: 8px 16px; background: #e5edff; color: #1d4ed8; border: 1px solid #c7d7ff; border-radius: 6px; cursor: pointer; font-weight: 500; }
    .quick-btn:hover { background: #d7e5ff; }
    .quick-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
  </style>
</head>
<body>
  <header>
    <h1>åº”ç”¨æ—¥å¿—åˆ†æé¢æ¿</h1>
    <button onclick="refreshAll()">ğŸ”„ åˆ·æ–°</button>
  </header>
  <main>
    <!-- ä»ªè¡¨æ¿ç»Ÿè®¡ -->
    <div class="dashboard">
      <div class="stat-card">
        <div class="stat-label">è¿è¡Œä¸­ä»»åŠ¡</div>
        <div class="stat-value" id="statRunning">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ä»Šæ—¥æŠ¥å‘Š</div>
        <div class="stat-value" id="statTodayReports">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">æ€»æŠ¥å‘Šæ•°</div>
        <div class="stat-value" id="statTotalReports">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ç³»ç»ŸçŠ¶æ€</div>
        <div class="stat-value" id="statHealth" style="font-size: 18px;">æ£€æŸ¥ä¸­...</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">è‡ªåŠ¨ç›‘æ§</div>
        <div class="stat-value" id="statMonitoring" style="font-size: 18px;">æ£€æŸ¥ä¸­...</div>
      </div>
    </div>

    <!-- å¿«é€Ÿåˆ†æ -->
    <div class="card">
      <h3>âš¡ å¿«é€Ÿåˆ†æ</h3>
      <div class="quick-actions">
        <button class="quick-btn" onclick="quickAnalyze(10, '')">è¿‘10åˆ†é’Ÿ</button>
        <button class="quick-btn" onclick="quickAnalyze(30, '')">è¿‘30åˆ†é’Ÿ</button>
        <button class="quick-btn" onclick="quickAnalyze(60, '')">è¿‘1å°æ—¶</button>
        <button class="quick-btn" onclick="quickAnalyze(360, '')">è¿‘6å°æ—¶</button>
        <button class="quick-btn" onclick="quickAnalyze(1440, '')">è¿‘1å¤©</button>
      </div>
      <div style="margin-top: 12px;">
        <label>å®¹å™¨ï¼š</label>
        <select id="quickContainer" style="width: 200px;">
          <option value="">å…¨éƒ¨</option>
          <option value="dispatcher">dispatcher</option>
          <option value="agent_python">agent_python</option>
          <option value="mcp_server">mcp_server</option>
        </select>
      </div>
    </div>

    <!-- ä»»åŠ¡æ‰§è¡Œä¸è¿›åº¦ -->
    <div class="card">
      <h3>ğŸ“‹ ä»»åŠ¡æ‰§è¡Œ</h3>
      <div class="row">
        <div class="col">
          <div><label>ä»»åŠ¡ï¼š</label><select id="taskSelect"></select></div>
          <div><label>å®¹å™¨ï¼š</label>
            <select id="container">
              <option value="">å…¨éƒ¨ï¼ˆæŒ‰ä»»åŠ¡é…ç½®ï¼‰</option>
              <option value="dispatcher">dispatcher</option>
              <option value="agent_python">agent_python</option>
              <option value="mcp_server">mcp_server</option>
            </select>
          </div>
          <div><label>åˆ†é’ŸèŒƒå›´ï¼š</label><input id="minutes_ago" type="number" min="1" placeholder="ä¼˜å…ˆ"/></div>
          <div><label>å°æ—¶èŒƒå›´ï¼š</label><input id="hours_ago" type="number" min="1" placeholder="æœªå¡«åˆ†é’Ÿæ—¶"/></div>
          <div class="chips">
            <span class="chip" onclick="quickRangeMinutes(10)">è¿‘10åˆ†é’Ÿ</span>
            <span class="chip" onclick="quickRangeMinutes(30)">è¿‘30åˆ†é’Ÿ</span>
            <span class="chip" onclick="quickRangeHours(1)">è¿‘1å°æ—¶</span>
            <span class="chip" onclick="quickRangeHours(6)">è¿‘6å°æ—¶</span>
            <span class="chip" onclick="quickRangeHours(24)">è¿‘1å¤©</span>
            <span class="chip" onclick="clearTime()">æ¸…ç©ºæ—¶é—´</span>
          </div>
        </div>
      </div>
      <button onclick="runTask()" id="runTaskBtn">æ‰§è¡Œ</button>
      <div id="runResult" class="muted" style="margin-top:6px;"></div>
      
      <!-- å®æ—¶è¿›åº¦æ˜¾ç¤º -->
      <div id="progressContainer" style="display:none; margin-top:16px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
          <span id="progressStage" class="muted">å‡†å¤‡ä¸­...</span>
          <span id="progressPercent" class="muted">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width:0%"></div>
        </div>
        <div id="progressDetail" class="muted" style="margin-top:4px; font-size:12px;"></div>
      </div>
    </div>

    <!-- æŸ¥çœ‹æŠ¥å‘Š -->
    <div class="card">
      <h3>ğŸ“Š æŸ¥çœ‹æŠ¥å‘Š</h3>
      <div class="row">
        <div class="col">
          <div><label>å®¹å™¨ç­›é€‰ï¼š</label>
            <select id="report_container" onchange="loadReports()">
              <option value="">å…¨éƒ¨</option>
              <option value="dispatcher">dispatcher</option>
              <option value="agent_python">agent_python</option>
              <option value="mcp_server">mcp_server</option>
            </select>
          </div>
          <div class="inline">
            <label>æ˜¾ç¤ºæ•°é‡ï¼š</label>
            <select id="report_limit" onchange="loadReports()">
              <option value="10" selected>æœ€è¿‘10ä¸ª</option>
              <option value="20">æœ€è¿‘20ä¸ª</option>
              <option value="50">æœ€è¿‘50ä¸ª</option>
              <option value="">ä¸é™</option>
            </select>
          </div>
          <div><label>å¼€å§‹æ—¶é—´ï¼š</label><input id="report_start" placeholder="YYYY-MM-DD HH:MM:SS" onchange="loadReports()"/></div>
          <div><label>ç»“æŸæ—¶é—´ï¼š</label><input id="report_end" placeholder="YYYY-MM-DD HH:MM:SS" onchange="loadReports()"/></div>
          <div class="chips">
            <span class="chip" onclick="setReportRange('24h')">è¿‘24å°æ—¶</span>
            <span class="chip" onclick="setReportRange('today')">ä»Šå¤©</span>
            <span class="chip" onclick="setReportRange('7d')">è¿‘7å¤©</span>
            <span class="chip" onclick="clearReportRange()">æ¸…ç©ºæ—¶é—´</span>
          </div>
          <div style="margin-top:12px;"><label>æˆ–è¾“å…¥æŠ¥å‘ŠIDï¼š</label><input id="report_id" placeholder="run_id æˆ– æ—¶é—´_å®¹å™¨å" /></div>
          <button onclick="getReportById()">æ‰‹åŠ¨è·å–æŠ¥å‘Š</button>
        </div>
        <div class="col">
          <div style="margin-bottom:8px;"><strong>æœ€è¿‘æŠ¥å‘Šåˆ—è¡¨ï¼ˆç‚¹å‡»æŸ¥çœ‹ï¼‰ï¼š</strong></div>
          <div id="reportList" style="max-height:300px; overflow-y:auto;"></div>
        </div>
      </div>
      <div style="margin-top:16px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <h3 style="margin:0;">ğŸ“„ æŠ¥å‘Šå†…å®¹</h3>
          <button onclick="copyReport()" style="padding:6px 12px; font-size:13px;">ğŸ“‹ å¤åˆ¶æŠ¥å‘Š</button>
        </div>
        <div id="reportContent" class="markdown-content"></div>
      </div>
    </div>
  </main>

  <script>
    let pollingInterval = null;
    let currentRunId = null;

    function fmt(dt) {
      const pad = (n) => n.toString().padStart(2, '0');
      return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;
    }
    async function fetchJSON(url, opts={}) {
      const res = await fetch(url, opts);
      if (!res.ok) {
        let msg = await res.text();
        throw new Error(msg || res.statusText);
      }
      return res.json();
    }
    function showNotification(message, type = 'success') {
      const notif = document.createElement('div');
      notif.className = `notification ${type}`;
      notif.textContent = message;
      document.body.appendChild(notif);
      setTimeout(() => {
        notif.style.animation = 'slideIn 0.3s reverse';
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }
    async function updateStats() {
      try {
        const reports = await fetchJSON('/api/reports?limit=100');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayReports = reports.reports.filter(r => {
          const date = new Date(r.created_at);
          return date >= today;
        });
        document.getElementById('statTodayReports').textContent = todayReports.length;
        document.getElementById('statTotalReports').textContent = reports.reports.length;
        
        // ç»Ÿè®¡è¿è¡Œä¸­çš„ä»»åŠ¡ï¼ˆéœ€è¦ä»runsè·å–ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
        const runningCount = document.querySelectorAll('.status.running').length;
        document.getElementById('statRunning').textContent = runningCount;
        
        // æ›´æ–°ç›‘æ§çŠ¶æ€
        try {
          const monitoring = await fetchJSON('/api/monitoring/status');
          const monitoringEl = document.getElementById('statMonitoring');
          if (monitoringEl) {
            if (monitoring.enabled) {
              monitoringEl.textContent = 'âœ… å·²å¯ç”¨';
              monitoringEl.style.color = 'var(--success)';
            } else {
              monitoringEl.textContent = 'â¸ï¸ å·²åœç”¨';
              monitoringEl.style.color = 'var(--muted)';
            }
          }
        } catch (e) {
          console.error('è·å–ç›‘æ§çŠ¶æ€å¤±è´¥:', e);
        }
      } catch (e) {
        console.error('æ›´æ–°ç»Ÿè®¡å¤±è´¥:', e);
      }
    }
    async function health() {
      try {
        const h = await fetchJSON('/health');
        document.getElementById('statHealth').textContent = 'âœ… æ­£å¸¸';
        document.getElementById('statHealth').style.color = 'var(--success)';
      } catch (e) {
        document.getElementById('statHealth').textContent = 'âŒ å¼‚å¸¸';
        document.getElementById('statHealth').style.color = 'var(--danger)';
      }
    }
    async function tasks() {
      try {
        const t = await fetchJSON('/api/tasks');
        const sel = document.getElementById('taskSelect');
        sel.innerHTML = '';
        t.tasks.forEach(task => {
          const opt = document.createElement('option');
          opt.value = task.name;
          opt.textContent = task.name === 'Apps_Error_Analysis' ? 'App' : task.name;
          sel.appendChild(opt);
        });
      } catch (e) {
        console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', e);
      }
    }
    function startPolling(runId) {
      if (pollingInterval) clearInterval(pollingInterval);
      currentRunId = runId;
      const progressContainer = document.getElementById('progressContainer');
      const runIdEl = document.getElementById('run_id');
      if (progressContainer) progressContainer.style.display = 'block';
      if (runIdEl) runIdEl.value = runId;
      
      pollingInterval = setInterval(async () => {
        try {
          const r = await fetchJSON(`/api/runs/${runId}`);
          updateProgress(r);
          
          if (r.status === 'completed' || r.status === 'failed') {
            clearInterval(pollingInterval);
            pollingInterval = null;
            if (r.status === 'completed') {
              showNotification('âœ… åˆ†æå®Œæˆï¼', 'success');
              if (r.report_id) {
                setTimeout(() => viewReport(r.report_id), 1000);
              }
              loadReports();
              updateStats();
            } else {
              showNotification('âŒ åˆ†æå¤±è´¥: ' + (r.error || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
          }
        } catch (e) {
          console.error('è½®è¯¢å¤±è´¥:', e);
        }
      }, 2000);
    }
    function updateProgress(run) {
      const stage = run.stage || 'queued';
      const progress = run.progress || {};
      const percentage = progress.percentage || 0;
      
      const stageMap = {
        'queued': 'æ’é˜Ÿä¸­...',
        'collecting': 'æ”¶é›†æ—¥å¿—...',
        'analyzing': 'åˆ†æä¸­...',
        'saving': 'ä¿å­˜ç»“æœ...',
        'finished': 'å·²å®Œæˆ',
        'failed': 'å¤±è´¥'
      };
      
      document.getElementById('progressStage').textContent = stageMap[stage] || stage;
      document.getElementById('progressPercent').textContent = percentage + '%';
      document.getElementById('progressFill').style.width = percentage + '%';
      document.getElementById('progressDetail').textContent = 
        `å·²å¤„ç†: ${progress.processed_chunks || 0} / ${progress.total_chunks || 0} å—`;
      
      if (run.error) {
        document.getElementById('progressDetail').textContent = 'é”™è¯¯: ' + run.error;
        document.getElementById('progressDetail').style.color = 'var(--danger)';
      }
    }
    function quickAnalyze(minutes, container) {
      const containerName = container || (document.getElementById('quickContainer')?.value || '');
      const containerEl = document.getElementById('container');
      const minutesEl = document.getElementById('minutes_ago');
      const hoursEl = document.getElementById('hours_ago');
      if (containerEl) containerEl.value = containerName;
      if (minutesEl) minutesEl.value = minutes;
      if (hoursEl) hoursEl.value = '';
      runTask();
    }
    function refreshAll() {
      health();
      tasks();
      loadReports();
      updateStats();
    }
    function buildParams() {
      const params = new URLSearchParams();
      const ids = ['minutes_ago','hours_ago','container','since','until'];
      ids.forEach(id => {
        const v = document.getElementById(id)?.value;
        if (v) params.append(id === 'container' ? 'container_name' : id, v);
      });
      return params.toString();
    }
    function quickRangeMinutes(m) {
      const minutesEl = document.getElementById('minutes_ago');
      const hoursEl = document.getElementById('hours_ago');
      const sinceEl = document.getElementById('since');
      const untilEl = document.getElementById('until');
      if (minutesEl) minutesEl.value = m;
      if (hoursEl) hoursEl.value = '';
      if (sinceEl) sinceEl.value = '';
      if (untilEl) untilEl.value = '';
    }
    function quickRangeHours(h) {
      const minutesEl = document.getElementById('minutes_ago');
      const hoursEl = document.getElementById('hours_ago');
      const sinceEl = document.getElementById('since');
      const untilEl = document.getElementById('until');
      if (minutesEl) minutesEl.value = '';
      if (hoursEl) hoursEl.value = h;
      if (sinceEl) sinceEl.value = '';
      if (untilEl) untilEl.value = '';
    }
    function clearTime() {
      const minutesEl = document.getElementById('minutes_ago');
      const hoursEl = document.getElementById('hours_ago');
      const sinceEl = document.getElementById('since');
      const untilEl = document.getElementById('until');
      if (minutesEl) minutesEl.value = '';
      if (hoursEl) hoursEl.value = '';
      if (sinceEl) sinceEl.value = '';
      if (untilEl) untilEl.value = '';
    }
    async function runTask() {
      const taskSelect = document.getElementById('taskSelect');
      if (!taskSelect || !taskSelect.value) {
        showNotification('è¯·å…ˆé€‰æ‹©ä»»åŠ¡', 'error');
        return;
      }
      const task = taskSelect.value;
      const qs = buildParams();
      const url = `/api/tasks/${encodeURIComponent(task)}/run` + (qs ? `?${qs}` : '');
      const runResult = document.getElementById('runResult');
      const runTaskBtn = document.getElementById('runTaskBtn');
      const reportIdEl = document.getElementById('report_id');
      if (runResult) runResult.textContent = 'å¯åŠ¨ä¸­...';
      if (runTaskBtn) runTaskBtn.disabled = true;
      try {
        const res = await fetchJSON(url, { method: 'POST' });
        if (runResult) runResult.textContent = 'âœ… å·²å¯åŠ¨ï¼Œè¿è¡ŒID=' + res.run_id;
        if (reportIdEl) reportIdEl.value = res.run_id;
        startPolling(res.run_id);
        updateStats();
      } catch (e) {
        if (runResult) runResult.textContent = 'âŒ é”™è¯¯: ' + e.message;
        showNotification('å¯åŠ¨å¤±è´¥: ' + e.message, 'error');
      } finally {
        if (runTaskBtn) runTaskBtn.disabled = false;
      }
    }
    async function loadReports() {
      const params = new URLSearchParams();
      const reportContainer = document.getElementById('report_container');
      const reportStart = document.getElementById('report_start');
      const reportEnd = document.getElementById('report_end');
      const reportLimit = document.getElementById('report_limit');
      const c = reportContainer?.value || '';
      const s = reportStart?.value || '';
      const e = reportEnd?.value || '';
      const limit = reportLimit?.value || '10';
      if (c) params.append('container_name', c);
      if (s) params.append('start_time', s);
      if (e) params.append('end_time', e);
      params.append('limit', limit);
      const url = '/api/reports' + (params.toString() ? `?${params.toString()}` : '');
      try {
        const data = await fetchJSON(url);
        const reports = data.reports || [];
        const listDiv = document.getElementById('reportList');
        if (reports.length === 0) {
          listDiv.innerHTML = '<div class="muted">æš‚æ— æŠ¥å‘Š</div>';
          return;
        }
        listDiv.innerHTML = reports.map(r => {
          const time = r.created_at ? r.created_at.replace('T', ' ').substring(0, 19) : '-';
          return `<div class="report-item" onclick="viewReport('${r.id}')" data-id="${r.id}">
            <div class="report-item-title">æŠ¥å‘ŠID: ${r.id}</div>
            <div class="report-item-meta">å®¹å™¨: ${r.container_name || 'all'} | æ—¶é—´: ${time} | ä»»åŠ¡: ${r.task_name || '-'}</div>
          </div>`;
        }).join('');
      } catch (err) {
        document.getElementById('reportList').innerHTML = '<div style="color:#b91c1c;">é”™è¯¯: ' + err.message + '</div>';
      }
    }
    function setReportRange(type) {
      const now = new Date();
      let start = '';
      if (type === '24h') {
        start = fmt(new Date(now.getTime() - 24*60*60*1000));
      } else if (type === 'today') {
        const dt = new Date(now);
        dt.setHours(0,0,0,0);
        start = fmt(dt);
      } else if (type === '7d') {
        start = fmt(new Date(now.getTime() - 7*24*60*60*1000));
      }
      const reportStart = document.getElementById('report_start');
      const reportEnd = document.getElementById('report_end');
      if (reportStart) reportStart.value = start;
      if (reportEnd) reportEnd.value = fmt(now);
      loadReports();
    }
    function clearReportRange() {
      const reportStart = document.getElementById('report_start');
      const reportEnd = document.getElementById('report_end');
      if (reportStart) reportStart.value = '';
      if (reportEnd) reportEnd.value = '';
      loadReports();
    }
    async function viewReport(reportId) {
      const reportIdEl = document.getElementById('report_id');
      if (reportIdEl) reportIdEl.value = reportId;
      document.querySelectorAll('.report-item').forEach(el => el.classList.remove('active'));
      document.querySelector(`[data-id="${reportId}"]`)?.classList.add('active');
      try {
        const r = await fetch(`/api/reports/${reportId}`);
        if (!r.ok) throw new Error(await r.text());
        const text = await r.text();
        // ä½¿ç”¨markedæ¸²æŸ“Markdown
        if (typeof marked !== 'undefined') {
          // é…ç½®markedé€‰é¡¹ï¼Œæ”¯æŒGFMæ¢è¡Œ
          marked.setOptions({
            breaks: true,  // æ”¯æŒGFMæ¢è¡Œï¼ˆä¸¤ä¸ªç©ºæ ¼+æ¢è¡Œæˆ–ç›´æ¥æ¢è¡Œï¼‰
            gfm: true,     // å¯ç”¨GitHub Flavored Markdown
            headerIds: true,
            mangle: false
          });
          const html = marked.parse(text);
          document.getElementById('reportContent').innerHTML = html;
        } else {
          // å¦‚æœæ²¡æœ‰markedåº“ï¼Œè‡³å°‘ä¿æŒæ¢è¡Œ
          const content = document.getElementById('reportContent');
          content.style.whiteSpace = 'pre-wrap';
          content.textContent = text;
        }
        // æ»šåŠ¨åˆ°æŠ¥å‘ŠåŒºåŸŸ
        document.getElementById('reportContent').scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (e) {
        document.getElementById('reportContent').innerHTML = '<div style="color:var(--danger);">é”™è¯¯: ' + e.message + '</div>';
      }
    }
    async function getReportById() {
      const id = document.getElementById('report_id').value;
      if (!id) return;
      await viewReport(id);
    }
    function copyReport() {
      const content = document.getElementById('reportContent');
      if (!content) return;
      const text = content.innerText || content.textContent;
      navigator.clipboard.writeText(text).then(() => {
        showNotification('âœ… æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
      }).catch(() => {
        showNotification('âŒ å¤åˆ¶å¤±è´¥', 'error');
      });
    }
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    health();
    tasks();
    loadReports();
    updateStats();
    
    // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ç»Ÿè®¡å’ŒæŠ¥å‘Šåˆ—è¡¨
    setInterval(() => {
      updateStats();
      loadReports();
    }, 30000);
  </script>
</body>
</html>
