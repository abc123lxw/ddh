<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>æ•°æ®åº“è¿ç»´åˆ†æå¹³å°</title>
  <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
  <style>
    :root {
      --primary: #0ea5e9;
      --secondary: #8b5cf6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --bg: #0f172a;
      --bg-card: #1e293b;
      --bg-hover: #334155;
      --border: #334155;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --accent: #06b6d4;
    }
    
    * { box-sizing: border-box; }
    
    body {
      font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    
    /* é¡¶éƒ¨å¯¼èˆªæ  - æ·±è‰²ä¸“ä¸šé£æ ¼ */
    header {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border-bottom: 2px solid var(--primary);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(14, 165, 233, 0.1);
    }
    
    header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
      background: linear-gradient(135deg, #0ea5e9, #8b5cf6);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    header h1::before {
      content: "ğŸ—„ï¸";
      font-size: 28px;
      -webkit-text-fill-color: var(--primary);
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #0284c7;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
    }
    
    .btn-secondary {
      background: var(--bg-card);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
      background: var(--bg-hover);
    }
    
    main {
      padding: 24px;
      max-width: 1600px;
      margin: 0 auto;
    }
    
    /* æŒ‡æ ‡å¡ç‰‡ç½‘æ ¼ - æ•°æ®åº“ä¸“ç”¨ */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .metric-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s;
    }
    
    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }
    
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(14, 165, 233, 0.15);
      border-color: var(--primary);
    }
    
    .metric-label {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .metric-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
      margin: 8px 0;
    }
    
    .metric-trend {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .metric-trend.up { color: var(--success); }
    .metric-trend.down { color: var(--danger); }
    
    /* ä¸»å†…å®¹å¡ç‰‡ */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }
    
    .card-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* æ•°æ®åº“è¿æ¥é…ç½®åŒºåŸŸ */
    .db-config {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .form-group label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .form-group input,
    .form-group select {
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .form-group input:hover,
    .form-group select:hover {
      border-color: var(--primary);
      background: rgba(14, 165, 233, 0.05);
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
      background: var(--bg-card);
    }
    
    .form-hint {
      display: block;
      font-size: 12px;
      margin-top: 6px;
      line-height: 1.5;
    }
    
    /* åˆ†æé€‰é¡¹æ ‡ç­¾ */
    .analysis-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 16px 0;
    }
    
    .tag {
      padding: 8px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .tag:hover {
      border-color: var(--primary);
      background: rgba(14, 165, 233, 0.1);
    }
    
    .tag.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .tag input[type="checkbox"] {
      margin: 0;
      cursor: pointer;
    }
    
    /* æ‰§è¡ŒæŒ‰é’® */
    .action-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    
    .btn-large {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 700;
    }
    
    /* è¿›åº¦æ˜¾ç¤º - æ•°æ®åº“é£æ ¼ */
    .progress-container {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 14px;
    }
    
    .progress-bar-wrapper {
      width: 100%;
      height: 12px;
      background: var(--bg);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transition: width 0.3s;
      border-radius: 6px;
      position: relative;
    }
    
    .progress-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* æŠ¥å‘Šåˆ—è¡¨ - æ•°æ®åº“é£æ ¼ */
    .reports-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    
    .report-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    
    .report-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(14, 165, 233, 0.2);
    }
    
    .report-card.active {
      border-color: var(--primary);
      background: rgba(14, 165, 233, 0.1);
    }
    
    .report-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }
    
    .report-id {
      font-family: 'Consolas', monospace;
      font-size: 12px;
      color: var(--text-muted);
      background: var(--bg-card);
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .report-time {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .report-db-info {
      display: flex;
      gap: 12px;
      margin-top: 8px;
      font-size: 13px;
    }
    
    .report-db-info span {
      padding: 4px 10px;
      background: var(--bg-card);
      border-radius: 12px;
      color: var(--text-muted);
    }
    
    /* æŠ¥å‘Šå†…å®¹åŒºåŸŸ */
    .report-viewer {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 30px;
      margin-top: 20px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    
    .report-viewer::-webkit-scrollbar {
      width: 10px;
    }
    
    .report-viewer::-webkit-scrollbar-track {
      background: var(--bg);
      border-radius: 5px;
    }
    
    .report-viewer::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 5px;
    }
    
    .report-viewer::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }
    
    .markdown-content {
      color: var(--text);
      line-height: 1.8;
      font-size: 15px;
      max-width: 100%;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    .markdown-content p {
      margin: 8px 0;
      line-height: 1.6;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    .markdown-content p:empty {
      margin: 8px 0;
    }
    
    .markdown-content > * {
      max-width: 100%;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    .markdown-content h1 {
      font-size: 32px;
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
      padding-bottom: 15px;
      margin-top: 0;
      margin-bottom: 20px;
      margin-top: 20px;
      font-weight: 700;
      line-height: 1.3;
    }
    
    .markdown-content h1:first-child {
      margin-top: 0;
    }
    
    .markdown-content h2 {
      font-size: 24px;
      color: var(--text);
      margin-top: 32px;
      margin-bottom: 18px;
      border-bottom: 2px solid var(--border);
      padding-bottom: 12px;
      font-weight: 600;
      line-height: 1.6;
    }
    
    .markdown-content h2:first-child {
      margin-top: 0;
    }
    
    .markdown-content h3 {
      font-size: 20px;
      color: var(--accent);
      margin-top: 28px;
      margin-bottom: 16px;
      font-weight: 600;
      padding-left: 12px;
      border-left: 4px solid var(--accent);
      line-height: 1.6;
    }
    
    .markdown-content h4 {
      font-size: 17px;
      color: var(--text-muted);
      margin-top: 24px;
      margin-bottom: 14px;
      font-weight: 500;
      line-height: 1.6;
    }
    
    .markdown-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: var(--bg-card);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .markdown-content table th,
    .markdown-content table td {
      border: 1px solid var(--border);
      padding: 14px 16px;
      text-align: left;
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 300px;
      line-height: 1.6;
    }
    
    .markdown-content table th {
      background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg) 100%);
      font-weight: 700;
      color: var(--primary);
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 0.5px;
      max-width: 200px;
      white-space: nowrap;
    }
    
    .markdown-content table tr:hover {
      background: rgba(14, 165, 233, 0.05);
    }
    
    /* æ•°æ®ç»Ÿè®¡è¡¨ï¼šæŠ¥å‘Šå†…ç¬¬ä¸€ä¸ªè¡¨æ ¼ï¼ˆMarkdown æ¸²æŸ“ï¼‰ï¼Œåˆ—å¯¹é½ã€å¯è§†æ€§å¥½ */
    #reportContent table:first-of-type {
      table-layout: fixed;
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: var(--bg-card);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #reportContent table:first-of-type th,
    #reportContent table:first-of-type td {
      border: 1px solid var(--border);
      padding: 12px 16px;
      vertical-align: middle;
      box-sizing: border-box;
      line-height: 1.5;
    }
    #reportContent table:first-of-type th {
      background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg) 100%);
      font-weight: 700;
      color: var(--primary);
      font-size: 14px;
    }
    #reportContent table:first-of-type th:nth-child(1),
    #reportContent table:first-of-type td:nth-child(1) {
      width: 48%;
      text-align: left;
    }
    #reportContent table:first-of-type th:nth-child(2),
    #reportContent table:first-of-type td:nth-child(2) {
      width: 22%;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    #reportContent table:first-of-type th:nth-child(3),
    #reportContent table:first-of-type td:nth-child(3) {
      width: 30%;
      text-align: center;
    }
    #reportContent table:first-of-type tbody tr:hover {
      background: rgba(14, 165, 233, 0.05);
    }
    
    .markdown-content code {
      background: rgba(14, 165, 233, 0.15);
      padding: 3px 8px;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      color: var(--accent);
      font-size: 14px;
      border: 1px solid rgba(14, 165, 233, 0.2);
    }
    
    .markdown-content pre {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-left: 4px solid var(--primary);
      padding: 18px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 20px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .markdown-content pre code {
      background: transparent;
      padding: 0;
      color: var(--text);
      border: none;
    }
    
    .markdown-content p {
      margin: 18px 0;
      color: var(--text);
      word-wrap: break-word;
      overflow-wrap: break-word;
      line-height: 2.2;
    }
    
    .markdown-content p:first-child {
      margin-top: 0;
    }
    
    .markdown-content p:last-child {
      margin-bottom: 0;
    }
    
    .markdown-content br {
      display: block;
      margin: 10px 0;
      line-height: 2.2;
    }
    
    .markdown-content ul, .markdown-content ol {
      margin: 20px 0;
      padding-left: 32px;
    }
    
    .markdown-content li {
      margin: 14px 0;
      color: var(--text);
      line-height: 2.2;
    }
    
    .markdown-content li p {
      margin: 8px 0;
    }
    
    .markdown-content blockquote {
      border-left: 4px solid var(--primary);
      padding: 15px 20px;
      margin: 20px 0;
      background: rgba(14, 165, 233, 0.05);
      border-radius: 6px;
      color: var(--text-muted);
      font-style: italic;
    }
    
    .markdown-content hr {
      border: none;
      border-top: 2px solid var(--border);
      margin: 28px 0;
      clear: both;
    }
    
    .markdown-content blockquote {
      margin: 20px 0;
      padding: 12px 16px;
      border-left: 4px solid var(--primary);
      background: rgba(14, 165, 233, 0.05);
      border-radius: 4px;
    }
    
    .markdown-content blockquote p {
      margin: 8px 0;
    }
    
    .markdown-content blockquote p:first-child {
      margin-top: 0;
    }
    
    .markdown-content blockquote p:last-child {
      margin-bottom: 0;
    }
    
    .markdown-content strong {
      color: var(--text);
      font-weight: 600;
    }
    
    .markdown-content em {
      color: var(--text-muted);
      font-style: italic;
    }
    
    /* çŠ¶æ€æ ‡ç­¾ */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-badge.success {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }
    
    .status-badge.warning {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }
    
    .status-badge.danger {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }
    
    .status-badge.info {
      background: rgba(14, 165, 233, 0.2);
      color: var(--primary);
    }
    
    /* ç­›é€‰å™¨ */
    .filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .filter-group label {
      font-size: 13px;
      color: var(--text-muted);
    }
    
    /* é€šçŸ¥ */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-left: 4px solid var(--primary);
      border-radius: 8px;
      padding: 16px 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      min-width: 300px;
      animation: slideInRight 0.3s;
    }
    
    .notification.success { border-left-color: var(--success); }
    .notification.error { border-left-color: var(--danger); }
    .notification.warning { border-left-color: var(--warning); }
    
    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    /* å“åº”å¼ */
    @media (max-width: 768px) {
      main { padding: 16px; }
      .metrics-grid { grid-template-columns: 1fr; }
      .db-config { grid-template-columns: 1fr; }
      .reports-grid { grid-template-columns: 1fr; }
    }

    /* ç™»å½•é¡µ */
    #loginScreen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #loginScreen.hidden { display: none; }
    .login-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 380px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }
    .login-card h2 {
      margin: 0 0 8px 0;
      font-size: 22px;
      background: linear-gradient(135deg, #0ea5e9, #8b5cf6);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .login-card .subtitle {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 28px;
    }
    .login-card .form-group { margin-bottom: 20px; }
    .login-card .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-muted);
    }
    .login-card .form-group input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 15px;
    }
    .login-card .form-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
    }
    .login-card .btn-login {
      width: 100%;
      padding: 14px;
      margin-top: 10px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .login-card .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(14, 165, 233, 0.35);
    }
    .login-card .login-error {
      margin-top: 12px;
      padding: 10px 12px;
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 8px;
      color: #fca5a5;
      font-size: 14px;
      display: none;
    }
    .login-card .login-error.visible { display: block; }
  </style>
</head>
<body>
  <!-- ç™»å½•é¡µï¼šæœªç™»å½•æ—¶æ˜¾ç¤º -->
  <div id="loginScreen">
    <div class="login-card">
      <h2>ğŸ—„ï¸ æ•°æ®åº“è¿ç»´åˆ†æå¹³å°</h2>
      <p class="subtitle">è¯·ç™»å½•åä½¿ç”¨</p>
      <form id="loginForm" onsubmit="return handleLogin(event)">
        <div class="form-group">
          <label for="loginUsername">è´¦å·</label>
          <input type="text" id="loginUsername" name="username" placeholder="è¯·è¾“å…¥è´¦å·" required autocomplete="username" />
        </div>
        <div class="form-group">
          <label for="loginPassword">å¯†ç </label>
          <input type="password" id="loginPassword" name="password" placeholder="è¯·è¾“å…¥å¯†ç " required autocomplete="current-password" />
        </div>
        <div class="login-error" id="loginError"></div>
        <button type="submit" class="btn-login">ç™» å½•</button>
      </form>
    </div>
  </div>

  <!-- ä¸»åº”ç”¨ï¼šç™»å½•åæ˜¾ç¤º -->
  <div id="appContent" style="display: none;">
  <header>
    <h1>æ•°æ®åº“è¿ç»´åˆ†æå¹³å°</h1>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="refreshAll()">ğŸ”„ åˆ·æ–°</button>
      <button class="btn btn-primary" onclick="runAnalysis()">â–¶ï¸ å¼€å§‹åˆ†æ</button>
      <button class="btn btn-secondary" onclick="logout()" title="é€€å‡ºç™»å½•">ğŸšª é€€å‡º</button>
    </div>
  </header>
  
  <main>
    <!-- æŒ‡æ ‡æ¦‚è§ˆ -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-label">æ•°æ®åº“è¿æ¥</div>
        <div class="metric-value" id="metricConnections">-</div>
        <div class="metric-trend">å®æ—¶ç›‘æ§</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">æ…¢æŸ¥è¯¢æ•°é‡</div>
        <div class="metric-value" id="metricSlowQueries">-</div>
        <div class="metric-trend">æœ€è¿‘24å°æ—¶</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">è¡¨æ•°é‡</div>
        <div class="metric-value" id="metricTables">-</div>
        <div class="metric-trend">å½“å‰æ•°æ®åº“</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">ç´¢å¼•æ•°é‡</div>
        <div class="metric-value" id="metricIndexes">-</div>
        <div class="metric-trend">ä¼˜åŒ–å»ºè®®</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">ä»Šæ—¥åˆ†æ</div>
        <div class="metric-value" id="metricTodayReports">0</div>
        <div class="metric-trend">æŠ¥å‘Šæ•°é‡</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">ç³»ç»ŸçŠ¶æ€</div>
        <div class="metric-value" id="metricHealth" style="font-size: 20px;">æ£€æŸ¥ä¸­...</div>
        <div class="metric-trend">æœåŠ¡çŠ¶æ€</div>
      </div>
    </div>

    <!-- æ•°æ®åº“åˆ†æé…ç½® -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">âš™ï¸ æ•°æ®åº“åˆ†æé…ç½®</h2>
        <span class="status-badge info" id="configStatus">æœªé…ç½®</span>
      </div>
      
      <div class="db-config">
        <!-- ä»»åŠ¡é€‰æ‹©ï¼ˆä¼˜å…ˆï¼šè¿æ¥ä¿¡æ¯æ¥è‡ª config.yamlï¼Œé¡µé¢ä¸ä¼ è´¦å·å¯†ç ï¼Œæ— ç½‘å®‰é—®é¢˜ï¼‰ -->
        <div class="form-group">
          <label>ä»»åŠ¡é€‰æ‹©</label>
          <select id="taskSelect" onchange="onTaskSelectChange()">
            <option value="">åŠ è½½ä¸­...</option>
          </select>
        </div>
        <!-- å½“å‰è¿æ¥ä¿¡æ¯ï¼ˆæ¥è‡ª config.yamlï¼Œä»…å±•ç¤ºä¸å«å¯†ç ï¼‰ -->
        <div class="form-group" id="connectionSummaryBlock">
          <label>å½“å‰è¿æ¥ä¿¡æ¯ï¼ˆæ¥è‡ª config.yamlï¼‰</label>
          <div id="connectionSummaryText" style="padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-muted); font-size: 14px;">
            è¯·å…ˆé€‰æ‹©ä»»åŠ¡
          </div>
        </div>
        <!-- ä½¿ç”¨é¡µé¢é…ç½®è¦†ç›–ï¼ˆé»˜è®¤æŠ˜å ï¼Œéœ€è¦æ—¶å±•å¼€ï¼‰ -->
        <div class="form-group">
          <button type="button" class="btn btn-secondary" id="togglePageConfigBtn" onclick="togglePageConfig()" style="margin-bottom: 8px;">
            â–¶ ä½¿ç”¨é¡µé¢é…ç½®è¦†ç›–ï¼ˆå¯é€‰ï¼‰
          </button>
          <div id="connectionFormSection" style="display: none;">
            <div class="form-group">
              <label>å·²ä¿å­˜çš„è¿æ¥</label>
              <div style="display: flex; gap: 8px;">
                <select id="connectionHistory" style="flex: 1;">
                  <option value="">-- é€‰æ‹©å·²ä¿å­˜çš„è¿æ¥ --</option>
                </select>
                <button class="btn btn-secondary" onclick="loadConnectionHistory()" title="åˆ·æ–°">ğŸ”„</button>
                <button class="btn btn-secondary" onclick="deleteConnection()" title="åˆ é™¤é€‰ä¸­è¿æ¥">ğŸ—‘ï¸</button>
              </div>
            </div>
            <div class="form-group">
              <label>æ•°æ®åº“ç±»å‹</label>
              <select id="dbType">
                <option value="mysql" selected>MySQL</option>
                <option value="postgresql">PostgreSQL</option>
                <option value="redis">Redis</option>
                <option value="mongodb">MongoDB</option>
              </select>
            </div>
            <div class="form-group">
              <label>ä¸»æœºåœ°å€</label>
              <input type="text" id="dbHost" placeholder="localhost" value="localhost" />
              <small class="form-hint" id="hostHint" style="display: none; color: #ff9800; margin-top: 5px;">ğŸ’¡ æç¤ºï¼šDocker ä¸­è¯·ä½¿ç”¨å®¹å™¨æœåŠ¡å</small>
            </div>
            <div class="form-group">
              <label>ç«¯å£</label>
              <input type="number" id="dbPort" placeholder="3306" value="3306" />
            </div>
            <div class="form-group">
              <label>æ•°æ®åº“å</label>
              <input type="text" id="dbName" placeholder="your_database" />
            </div>
            <div class="form-group">
              <label>ç”¨æˆ·å</label>
              <input type="text" id="dbUser" placeholder="root" />
            </div>
            <div class="form-group">
              <label>å¯†ç </label>
              <input type="password" id="dbPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
            </div>
            <div class="form-group" id="dbAuthSourceGroup" style="display: none;">
              <label>è®¤è¯æ•°æ®åº“ï¼ˆMongoDBï¼‰</label>
              <input type="text" id="dbAuthSource" placeholder="admin" value="admin" />
            </div>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 20px;">
        <label style="display: block; margin-bottom: 12px; color: var(--text-muted); font-weight: 600;">åˆ†æé€‰é¡¹</label>
        <div class="analysis-tags">
          <label class="tag active">
            <input type="checkbox" id="optSlowQueries" checked />
            <span>æ…¢æŸ¥è¯¢åˆ†æ</span>
          </label>
          <label class="tag active">
            <input type="checkbox" id="optProcesslist" checked />
            <span>è¿æ¥æ± åˆ†æ</span>
          </label>
          <label class="tag active">
            <input type="checkbox" id="optStatus" checked />
            <span>çŠ¶æ€ç›‘æ§</span>
          </label>
          <label class="tag active">
            <input type="checkbox" id="optVariables" checked />
            <span>é…ç½®å®¡è®¡</span>
          </label>
          <label class="tag active">
            <input type="checkbox" id="optIndexes" checked />
            <span>ç´¢å¼•åˆ†æ</span>
          </label>
          <label class="tag active">
            <input type="checkbox" id="optTables" checked />
            <span>è¡¨ç»“æ„åˆ†æ</span>
          </label>
        </div>
      </div>
      
      <div style="margin-top: 20px;">
        <label style="display: block; margin-bottom: 12px; color: var(--text-muted); font-weight: 600;">æ€§èƒ½ä¼˜åŒ–è®¾ç½®</label>
        <div class="db-config">
          <div class="form-group">
            <label>æŸ¥è¯¢è¶…æ—¶ (ç§’)</label>
            <input type="number" id="queryTimeout" value="30" min="10" max="300" />
          </div>
          <div class="form-group">
            <label>è¡¨ä¿¡æ¯é™åˆ¶</label>
            <input type="number" id="tableLimit" value="1000" min="100" max="10000" />
          </div>
          <div class="form-group">
            <label>ç´¢å¼•ä¿¡æ¯é™åˆ¶</label>
            <input type="number" id="indexLimit" value="5000" min="500" max="50000" />
          </div>
          <div class="form-group">
            <label>æ…¢æŸ¥è¯¢é™åˆ¶</label>
            <input type="number" id="slowQueryLimit" value="100" min="10" max="1000" />
          </div>
        </div>
      </div>
      
      <div class="action-section">
        <div>
          <label class="tag">
            <input type="checkbox" id="optReadOnly" checked />
            <span>åªè¯»æ¨¡å¼ï¼ˆæ¨èï¼‰</span>
          </label>
          <label class="tag" style="margin-left: 10px;">
            <input type="checkbox" id="optLowPriority" checked />
            <span>ä½ä¼˜å…ˆçº§æŸ¥è¯¢</span>
          </label>
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-secondary btn-large" onclick="testConnection()" id="testConnectionBtn">
            ğŸ” æµ‹è¯•è¿æ¥
          </button>
          <button class="btn btn-primary btn-large" onclick="runAnalysis()" id="runAnalysisBtn">
            ğŸš€ æ‰§è¡Œæ•°æ®åº“åˆ†æ
          </button>
        </div>
      </div>
      
      <!-- è¿›åº¦æ˜¾ç¤º -->
      <div id="progressContainer" style="display: none;" class="progress-container">
        <div class="progress-info">
          <span id="progressStage">å‡†å¤‡ä¸­...</span>
          <span id="progressPercent">0%</span>
        </div>
        <div class="progress-bar-wrapper">
          <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div style="margin-top: 12px; font-size: 13px; color: var(--text-muted);" id="progressDetail">
          æ­£åœ¨åˆå§‹åŒ–åˆ†æä»»åŠ¡...
        </div>
      </div>
    </div>

    <!-- æŠ¥å‘Šç®¡ç† -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">ğŸ“Š åˆ†ææŠ¥å‘Š</h2>
        <div class="filters">
          <div class="filter-group">
            <label>æ•°æ®åº“:</label>
            <select id="filterDatabase" onchange="loadReports()" style="padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
              <option value="">å…¨éƒ¨</option>
            </select>
          </div>
          <div class="filter-group">
            <label>æ˜¾ç¤º:</label>
            <select id="reportLimit" onchange="loadReports()" style="padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
              <option value="10" selected>æœ€è¿‘10ä¸ª</option>
              <option value="20">æœ€è¿‘20ä¸ª</option>
              <option value="50">æœ€è¿‘50ä¸ª</option>
            </select>
          </div>
        </div>
      </div>
      
      <div id="reportsList" class="reports-grid">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“‹</div>
          <div>æš‚æ— åˆ†ææŠ¥å‘Š</div>
          <div style="margin-top: 8px; font-size: 13px; color: var(--text-muted);">æ‰§è¡Œåˆ†æä»»åŠ¡åå°†æ˜¾ç¤ºæŠ¥å‘Š</div>
        </div>
      </div>
    </div>

    <!-- æŠ¥å‘Šå†…å®¹æŸ¥çœ‹å™¨ -->
    <div class="card" id="reportViewerCard" style="display: none;">
      <div class="card-header">
        <h2 class="card-title">ğŸ“„ æŠ¥å‘Šè¯¦æƒ…</h2>
        <div>
          <button class="btn btn-secondary" onclick="copyReport()" style="margin-right: 8px;">ğŸ“‹ å¤åˆ¶</button>
          <button class="btn btn-secondary" onclick="closeReport()">âœ• å…³é—­</button>
        </div>
      </div>
      
      <div id="reportContent" class="report-viewer markdown-content">
        <!-- æŠ¥å‘Šå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
      </div>
    </div>
  </main>
  </div><!-- /#appContent -->

  <script>
    let pollingInterval = null;
    let currentRunId = null;
    let currentTaskName = '';
    let tasksList = [];  // ä»»åŠ¡åˆ—è¡¨ï¼ˆå« connection_summaryï¼‰ï¼Œç”¨äºå±•ç¤ºè¿æ¥ä¿¡æ¯

    function onTaskSelectChange() {
      const sel = document.getElementById('taskSelect');
      if (!sel) return;
      currentTaskName = sel.value;
      const el = document.getElementById('connectionSummaryText');
      if (!el) return;
      const task = tasksList.find(t => t.name === currentTaskName);
      if (!task || !task.connection_summary) {
        el.textContent = currentTaskName ? 'è¯¥ä»»åŠ¡æ— è¿æ¥é…ç½®' : 'è¯·å…ˆé€‰æ‹©ä»»åŠ¡';
        return;
      }
      const c = task.connection_summary;
      const dbLabel = { mysql: 'MySQL', postgresql: 'PostgreSQL', redis: 'Redis', mongodb: 'MongoDB' }[c.db_type] || c.db_type;
      el.innerHTML = `<strong>${dbLabel}</strong> Â· ${c.host || '-'}:${c.port || '-'}${c.database ? ' / ' + c.database : ''}`;
    }

    function togglePageConfig() {
      const section = document.getElementById('connectionFormSection');
      const btn = document.getElementById('togglePageConfigBtn');
      if (!section || !btn) return;
      const show = section.style.display === 'none';
      section.style.display = show ? 'block' : 'none';
      btn.textContent = show ? 'â–¼ ä½¿ç”¨é¡µé¢é…ç½®è¦†ç›–ï¼ˆå¯é€‰ï¼‰' : 'â–¶ ä½¿ç”¨é¡µé¢é…ç½®è¦†ç›–ï¼ˆå¯é€‰ï¼‰';
      if (show) updateDbTypeUI();
    }

    // æ•°æ®åº“å¯†ç å¼±å£ä»¤æ ¡éªŒï¼ˆä¸åç«¯ä¸€è‡´ï¼Œç¬¦åˆç½‘å®‰è¦æ±‚ï¼‰
    const WEAK_DB_PASSWORDS = new Set([
      '123456', '12345678', '123456789', '1234567890', 'password', 'root', 'admin',
      '111111', '000000', 'qwerty', 'abc123', 'admin123', 'root123', 'password123',
      '123123', '654321', '888888', '666666', 'admin888', 'root888', 'test', 'test123'
    ]);
    const MIN_DB_PASSWORD_LENGTH = 8;
    function isWeakDbPassword(pw) {
      if (!pw || typeof pw !== 'string') return false;
      const p = pw.trim();
      if (p.length < MIN_DB_PASSWORD_LENGTH) return true;
      if (WEAK_DB_PASSWORDS.has(p.toLowerCase())) return true;
      if (/^\d+$/.test(p) || /^[a-zA-Z]+$/.test(p)) return true;
      return false;
    }

    // API å·¥å…·å‡½æ•°ï¼ˆæºå¸¦ cookie ä»¥æ”¯æŒç™»å½•æ€ï¼‰
    async function fetchJSON(url, opts = {}) {
      const finalOpts = { ...opts, credentials: opts.credentials ?? 'include' };
      const res = await fetch(url, finalOpts);
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(msg || res.statusText);
      }
      return res.json();
    }

    // ç™»å½•æ€æ£€æŸ¥ä¸ç™»å½•/ç™»å‡º
    async function checkAuth() {
      try {
        await fetchJSON('/api/auth/check');
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('appContent').style.display = '';
        initApp();
      } catch (e) {
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('appContent').style.display = 'none';
      }
    }
    let refreshIntervalId = null;
    function initApp() {
      checkHealth();
      loadTasks();
      loadReports();
      updateStats();
      if (refreshIntervalId) clearInterval(refreshIntervalId);
      refreshIntervalId = setInterval(function() {
        updateStats();
        loadReports();
      }, 30000);
    }
    async function handleLogin(ev) {
      ev.preventDefault();
      const errEl = document.getElementById('loginError');
      errEl.classList.remove('visible');
      errEl.textContent = '';
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      try {
        const res = await fetchJSON('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        if (res && res.ok !== false) {
          document.getElementById('loginScreen').classList.add('hidden');
          document.getElementById('appContent').style.display = '';
          initApp();
        }
      } catch (e) {
        let msg = 'è´¦å·æˆ–å¯†ç é”™è¯¯';
        try {
          const j = JSON.parse(e.message || '{}');
          if (j.detail) msg = j.detail;
        } catch (_) {
          if (e.message && !e.message.includes('401')) msg = e.message;
        }
        errEl.textContent = msg;
        errEl.classList.add('visible');
      }
    }
    async function logout() {
      try {
        await fetchJSON('/api/logout', { method: 'POST' });
      } catch (_) {}
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('appContent').style.display = 'none';
      document.getElementById('loginPassword').value = '';
      document.getElementById('loginError').classList.remove('visible');
    }

    function showNotification(message, type = 'success') {
      const notif = document.createElement('div');
      notif.className = `notification ${type}`;
      notif.textContent = message;
      document.body.appendChild(notif);
      setTimeout(() => {
        notif.style.animation = 'slideInRight 0.3s reverse';
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }

    // å¥åº·æ£€æŸ¥
    async function checkHealth() {
      try {
        const h = await fetchJSON('/health');
        document.getElementById('metricHealth').textContent = 'âœ… æ­£å¸¸';
        document.getElementById('metricHealth').style.color = 'var(--success)';
      } catch (e) {
        document.getElementById('metricHealth').textContent = 'âŒ å¼‚å¸¸';
        document.getElementById('metricHealth').style.color = 'var(--danger)';
      }
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    async function updateStats() {
      try {
        const reports = await fetchJSON('/api/reports?limit=100');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayReports = reports.reports.filter(r => {
          const date = new Date(r.created_at);
          return date >= today;
        });
        document.getElementById('metricTodayReports').textContent = todayReports.length;
      } catch (e) {
        console.error('æ›´æ–°ç»Ÿè®¡å¤±è´¥:', e);
      }
    }

    // æ ¹æ®æ•°æ®åº“ç±»å‹è°ƒæ•´é»˜è®¤ç«¯å£å’Œæ˜¾ç¤ºå­—æ®µ
    function updateDbTypeUI() {
      const dbType = document.getElementById('dbType').value;
      const portInput = document.getElementById('dbPort');
      const userGroup = document.getElementById('dbUser').closest('.form-group');
      const authSourceGroup = document.getElementById('dbAuthSourceGroup');
      const hostHint = document.getElementById('hostHint');
      const hostInput = document.getElementById('dbHost');
      
      // ä¿å­˜å½“å‰ç«¯å£å€¼ï¼ˆå¦‚æœç”¨æˆ·å·²ç»è¾“å…¥äº†ï¼‰
      const currentPort = portInput.value;
      
      // è®¾ç½®é»˜è®¤ç«¯å£ï¼ˆåªæœ‰åœ¨ç«¯å£ä¸ºç©ºæˆ–è€…æ˜¯é»˜è®¤å€¼æ—¶æ‰è®¾ç½®ï¼‰
      if (dbType === 'mysql') {
        if (!currentPort || currentPort === '5432' || currentPort === '6379' || currentPort === '27017') {
          portInput.value = 3306;
        }
        portInput.placeholder = '3306';
        userGroup.style.display = '';
        authSourceGroup.style.display = 'none';
        hostHint.style.display = 'none';
      } else if (dbType === 'postgresql') {
        if (!currentPort || currentPort === '3306' || currentPort === '6379' || currentPort === '27017') {
          portInput.value = 5432;
        }
        portInput.placeholder = '5432';
        userGroup.style.display = '';
        authSourceGroup.style.display = 'none';
        updateHostHint();
      } else if (dbType === 'redis') {
        if (!currentPort || currentPort === '3306' || currentPort === '5432' || currentPort === '27017') {
          portInput.value = 6379;
        }
        portInput.placeholder = '6379';
        userGroup.style.display = 'none';  // Redis å¯èƒ½ä¸éœ€è¦ç”¨æˆ·å
        authSourceGroup.style.display = 'none';
        hostHint.style.display = 'none';
      } else if (dbType === 'mongodb') {
        if (!currentPort || currentPort === '3306' || currentPort === '5432' || currentPort === '6379') {
          portInput.value = 27017;
        }
        portInput.placeholder = '27017';
        userGroup.style.display = '';
        authSourceGroup.style.display = '';
        hostHint.style.display = 'none';
      }
      // åˆ‡æ¢æ•°æ®åº“ç±»å‹æ—¶ï¼Œä»»åŠ¡ä¸‹æ‹‰æ¡†è‡ªåŠ¨é€‰ä¸­å¯¹åº”ç±»å‹çš„ç¬¬ä¸€ä¸ªä»»åŠ¡
      selectTaskForDbType(dbType);
    }

    // æ ¹æ®å½“å‰æ•°æ®åº“ç±»å‹é€‰ä¸­ç¬¬ä¸€ä¸ªåŒ¹é…çš„ä»»åŠ¡
    function selectTaskForDbType(dbType) {
      const taskSelect = document.getElementById('taskSelect');
      if (!taskSelect || !taskSelect.options.length) return;
      let matchedTask = null;
      for (let i = 0; i < taskSelect.options.length; i++) {
        const taskName = taskSelect.options[i].value.toLowerCase();
        const taskText = taskSelect.options[i].textContent.toLowerCase();
        if (dbType === 'mysql' && (taskName.includes('mysql') || taskText.includes('mysql'))) {
          matchedTask = taskSelect.options[i].value;
          break;
        }
        if (dbType === 'postgresql' && (taskName.includes('pg') || taskName.includes('postgres') || taskText.includes('pg') || taskText.includes('postgres'))) {
          matchedTask = taskSelect.options[i].value;
          break;
        }
        if (dbType === 'redis' && (taskName.includes('redis') || taskText.includes('redis'))) {
          matchedTask = taskSelect.options[i].value;
          break;
        }
        if (dbType === 'mongodb' && (taskName.includes('mongo') || taskText.includes('mongo'))) {
          matchedTask = taskSelect.options[i].value;
          break;
        }
      }
      if (matchedTask) {
        taskSelect.value = matchedTask;
        currentTaskName = matchedTask;
      }
    }
    
    // æ›´æ–°ä¸»æœºåœ°å€æç¤º
    function updateHostHint() {
      const dbType = document.getElementById('dbType').value;
      const hostHint = document.getElementById('hostHint');
      const hostInput = document.getElementById('dbHost');
      
      if (dbType === 'postgresql') {
        const host = hostInput.value.trim();
        if (host === 'localhost' || host === '127.0.0.1') {
          hostHint.style.display = 'block';
          hostHint.innerHTML = 'âš ï¸ è­¦å‘Šï¼šå¦‚æœdb_ops_analyzerè¿è¡Œåœ¨Dockerå®¹å™¨ä¸­ï¼Œä½¿ç”¨ localhost æ— æ³•è¿æ¥åˆ°PostgreSQLå®¹å™¨ã€‚è¯·ä½¿ç”¨å®¹å™¨æœåŠ¡åç§°ï¼ˆå¦‚ windmill-db-1ï¼‰';
        } else {
          hostHint.style.display = 'block';
          hostHint.innerHTML = 'ğŸ’¡ æç¤ºï¼šå¦‚æœdb_ops_analyzerè¿è¡Œåœ¨Dockerå®¹å™¨ä¸­ï¼Œè¯·ä½¿ç”¨PostgreSQLå®¹å™¨çš„æœåŠ¡åç§°ï¼ˆå¦‚ windmill-db-1ï¼‰è€Œä¸æ˜¯ä¸»æœºIP';
        }
      }
    }
    
    // ç›‘å¬æ•°æ®åº“ç±»å‹å˜åŒ–
    document.getElementById('dbType').addEventListener('change', updateDbTypeUI);
    
    // ç›‘å¬ä¸»æœºåœ°å€å˜åŒ–ï¼ˆåªæ·»åŠ ä¸€æ¬¡ï¼‰
    if (!document.getElementById('dbHost').hasAttribute('data-listener-added')) {
      document.getElementById('dbHost').addEventListener('input', updateHostHint);
      document.getElementById('dbHost').setAttribute('data-listener-added', 'true');
    }
    
    // è¿æ¥å†å²ç®¡ç†
    function getConnectionHistory() {
      try {
        const history = localStorage.getItem('db_connection_history');
        return history ? JSON.parse(history) : [];
      } catch (e) {
        return [];
      }
    }
    
    function saveConnectionHistory(history) {
      try {
        localStorage.setItem('db_connection_history', JSON.stringify(history));
      } catch (e) {
        console.error('ä¿å­˜è¿æ¥å†å²å¤±è´¥:', e);
      }
    }
    
    function addConnectionToHistory(config) {
      const history = getConnectionHistory();
      const connectionKey = `${config.db_type}_${config.host}_${config.port}_${config.database || 'default'}`;
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
      const existingIndex = history.findIndex(c => 
        c.db_type === config.db_type &&
        c.host === config.host &&
        c.port === config.port &&
        c.database === config.database
      );
      
      const connectionInfo = {
        ...config,
        key: connectionKey,
        saved_at: new Date().toISOString(),
        display_name: `${config.db_type.toUpperCase()} - ${config.host}:${config.port}${config.database ? '/' + config.database : ''}`
      };
      
      if (existingIndex >= 0) {
        history[existingIndex] = connectionInfo;
      } else {
        history.unshift(connectionInfo);
      }
      
      // æœ€å¤šä¿å­˜20ä¸ªè¿æ¥
      if (history.length > 20) {
        history.pop();
      }
      
      saveConnectionHistory(history);
      loadConnectionHistory();
    }
    
    function loadConnectionHistory() {
      const history = getConnectionHistory();
      const select = document.getElementById('connectionHistory');
      select.innerHTML = '<option value="">-- é€‰æ‹©å·²ä¿å­˜çš„è¿æ¥ --</option>';
      
      history.forEach((conn, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = conn.display_name || `${conn.db_type} - ${conn.host}:${conn.port}`;
        select.appendChild(option);
      });
    }
    
    function loadConnectionFromHistory() {
      const select = document.getElementById('connectionHistory');
      const index = parseInt(select.value);
      if (isNaN(index)) return;
      
      const history = getConnectionHistory();
      const conn = history[index];
      if (!conn) return;
      
      // å¡«å……è¡¨å•ï¼ˆåŒ…æ‹¬ç«¯å£ï¼‰
      const dbType = conn.db_type || 'mysql';
      document.getElementById('dbType').value = dbType;
      document.getElementById('dbHost').value = conn.host || '';
      
      // ç¡®ä¿ç«¯å£ä¹Ÿè¢«æ­£ç¡®è®¾ç½®ï¼ˆä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„ç«¯å£ï¼‰
      if (conn.port) {
        document.getElementById('dbPort').value = conn.port;
      } else {
        // æ ¹æ®æ•°æ®åº“ç±»å‹è®¾ç½®é»˜è®¤ç«¯å£
        if (dbType === 'mysql') {
          document.getElementById('dbPort').value = 3306;
        } else if (dbType === 'postgresql') {
          document.getElementById('dbPort').value = 5432;
        } else if (dbType === 'redis') {
          document.getElementById('dbPort').value = 6379;
        } else if (dbType === 'mongodb') {
          document.getElementById('dbPort').value = 27017;
        }
      }
      document.getElementById('dbName').value = conn.database || '';
      document.getElementById('dbUser').value = conn.user || '';
      document.getElementById('dbPassword').value = conn.password || '';
      if (conn.auth_source) {
        document.getElementById('dbAuthSource').value = conn.auth_source;
      }
      
      // ä¿å­˜ç«¯å£å€¼ï¼ˆåœ¨updateDbTypeUIä¹‹å‰ï¼‰
      const savedPort = conn.port;
      
      // æ›´æ–°UIï¼ˆè¿™ä¼šè®¾ç½®é»˜è®¤ç«¯å£ï¼Œä½†æˆ‘ä»¬ä¼šç«‹å³æ¢å¤ä¿å­˜çš„ç«¯å£ï¼‰
      updateDbTypeUI();
      
      // ç«‹å³æ¢å¤ä¿å­˜çš„ç«¯å£ï¼ˆå¿…é¡»åœ¨updateDbTypeUIä¹‹åï¼‰
      if (savedPort) {
        document.getElementById('dbPort').value = savedPort;
      }
      
      // æ ¹æ®æ•°æ®åº“ç±»å‹è‡ªåŠ¨é€‰æ‹©å¯¹åº”çš„ä»»åŠ¡
      const taskSelect = document.getElementById('taskSelect');
      if (taskSelect && taskSelect.options.length > 0) {
        // æŸ¥æ‰¾åŒ¹é…çš„ä»»åŠ¡ï¼ˆä¼˜å…ˆç²¾ç¡®åŒ¹é…ï¼Œç„¶åæ¨¡ç³ŠåŒ¹é…ï¼‰
        let matchedTask = null;
        const dbTypeLower = dbType.toLowerCase();
        
        // å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
        for (let i = 0; i < taskSelect.options.length; i++) {
          const taskName = taskSelect.options[i].value.toLowerCase();
          const taskText = taskSelect.options[i].textContent.toLowerCase();
          
          if (dbTypeLower === 'postgresql' && (taskName.includes('postgresql') || taskText.includes('postgresql'))) {
            matchedTask = taskSelect.options[i].value;
            break;
          } else if (dbTypeLower === 'mysql' && (taskName.includes('mysql') || taskText.includes('mysql'))) {
            matchedTask = taskSelect.options[i].value;
            break;
          } else if (dbTypeLower === 'redis' && (taskName.includes('redis') || taskText.includes('redis'))) {
            matchedTask = taskSelect.options[i].value;
            break;
          } else if (dbTypeLower === 'mongodb' && (taskName.includes('mongodb') || taskText.includes('mongodb'))) {
            matchedTask = taskSelect.options[i].value;
            break;
          }
        }
        
        if (matchedTask) {
          taskSelect.value = matchedTask;
          currentTaskName = matchedTask;
        }
      }
      
      showNotification('âœ… å·²åŠ è½½è¿æ¥ä¿¡æ¯', 'success');
    }
    
    function deleteConnection() {
      const select = document.getElementById('connectionHistory');
      const index = parseInt(select.value);
      if (isNaN(index)) {
        showNotification('âŒ è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¿æ¥', 'error');
        return;
      }
      
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¿æ¥å—ï¼Ÿ')) return;
      
      const history = getConnectionHistory();
      history.splice(index, 1);
      saveConnectionHistory(history);
      loadConnectionHistory();
      showNotification('âœ… å·²åˆ é™¤è¿æ¥', 'success');
    }
    
    // ç›‘å¬è¿æ¥å†å²é€‰æ‹©
    document.getElementById('connectionHistory').addEventListener('change', loadConnectionFromHistory);
    
    // åˆå§‹åŒ–åŠ è½½è¿æ¥å†å²
    loadConnectionHistory();
    
    // æµ‹è¯•è¿æ¥ï¼ˆé»˜è®¤ä½¿ç”¨ config.yamlï¼Œä¸ä¼ è´¦å·å¯†ç ï¼›å±•å¼€ã€Œä½¿ç”¨é¡µé¢é…ç½®ã€æ—¶ç”¨è¡¨å•ï¼‰
    async function testConnection() {
      const testBtn = document.getElementById('testConnectionBtn');
      const originalText = testBtn.textContent;
      testBtn.disabled = true;
      testBtn.textContent = 'â³ æµ‹è¯•ä¸­...';

      const finishTest = (result, errorMsg) => {
        testBtn.disabled = false;
        testBtn.textContent = originalText;
        if (result && result.status === 'success') {
          let msg = 'âœ… è¿æ¥æˆåŠŸï¼';
          if (result.version) msg += ` (${result.database_type} ${result.version})`;
          else msg += ` (${result.database_type})`;
          showNotification(msg, 'success');
        } else {
          showNotification('âŒ è¿æ¥å¤±è´¥', 'error');
          if (errorMsg) {
            setTimeout(() => {
              const d = document.createElement('div');
              d.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e1e1e; border: 2px solid #ff4444; border-radius: 8px; padding: 20px; max-width: 700px; max-height: 80vh; overflow-y: auto; z-index: 10000;';
              d.innerHTML = `<div style="color: #ff4444; font-weight: bold; margin-bottom: 15px;">âŒ è¿æ¥æµ‹è¯•å¤±è´¥</div><div style="color: #ccc; white-space: pre-wrap; font-size: 13px;">${errorMsg}</div><button onclick="this.parentElement.remove()" style="margin-top: 15px; padding: 8px 20px; background: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;">å…³é—­</button>`;
              document.body.appendChild(d);
            }, 300);
          }
        }
      };

      try {
        if (usePageConfig()) {
          const dbType = document.getElementById('dbType').value;
          const host = document.getElementById('dbHost').value;
          const port = parseInt(document.getElementById('dbPort').value) || 3306;
          const database = document.getElementById('dbName').value;
          const user = document.getElementById('dbUser').value;
          const password = document.getElementById('dbPassword').value;
          const authSource = document.getElementById('dbAuthSource').value;
          if (!host) { testBtn.disabled = false; testBtn.textContent = originalText; showNotification('âŒ è¯·å¡«å†™ä¸»æœºåœ°å€', 'error'); return; }
          if ((dbType === 'mysql' || dbType === 'postgresql') && (!user || !password)) { testBtn.disabled = false; testBtn.textContent = originalText; showNotification('âŒ è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ', 'error'); return; }
          if ((dbType === 'mysql' || dbType === 'postgresql') && password && isWeakDbPassword(password)) { testBtn.disabled = false; testBtn.textContent = originalText; showNotification('âŒ ä¸å…è®¸ä½¿ç”¨å¼±å£ä»¤è¿æ¥æ•°æ®åº“', 'error'); return; }
          if ((dbType === 'redis' || dbType === 'mongodb') && password && isWeakDbPassword(password)) { testBtn.disabled = false; testBtn.textContent = originalText; showNotification('âŒ ä¸å…è®¸ä½¿ç”¨å¼±å£ä»¤è¿æ¥æ•°æ®åº“', 'error'); return; }
          const testConfig = { db_type: dbType, host, port, database: database || null, user: user || null, password: password || null };
          if (dbType === 'mongodb' && authSource) testConfig.auth_source = authSource;
          const response = await fetch('/api/test-connection', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(testConfig) });
          const result = await response.json();
          finishTest(result, result.error || result.message);
          if (result.status === 'success') addConnectionToHistory({ db_type: dbType, host, port, database: database || null, user: user || null, password: password || null, auth_source: dbType === 'mongodb' ? authSource : null });
        } else {
          if (!currentTaskName) { testBtn.disabled = false; testBtn.textContent = originalText; showNotification('âŒ è¯·å…ˆé€‰æ‹©ä»»åŠ¡', 'error'); return; }
          const result = await fetchJSON(`/api/tasks/${currentTaskName}/test-connection`, { method: 'POST', credentials: 'include' });
          finishTest(result, result.error || result.message);
        }
      } catch (e) {
        testBtn.disabled = false;
        testBtn.textContent = originalText;
        showNotification('âŒ æµ‹è¯•è¿æ¥å¤±è´¥: ' + (e.message || String(e)), 'error');
      }
    }
    
    // æ‰§è¡Œåˆ†æï¼ˆé»˜è®¤ä½¿ç”¨ config.yaml ä¸ä¼ è´¦å·å¯†ç ï¼›å±•å¼€ã€Œä½¿ç”¨é¡µé¢é…ç½®ã€æ—¶ç”¨è¡¨å•ï¼‰
    async function runAnalysis() {
      if (!usePageConfig()) {
        if (!currentTaskName) {
          showNotification('âŒ è¯·å…ˆé€‰æ‹©ä»»åŠ¡', 'error');
          return;
        }
        const runBtn = document.getElementById('runAnalysisBtn');
        try {
          if (runBtn) { runBtn.disabled = true; runBtn.textContent = 'â³ å¯åŠ¨ä¸­...'; }
          const res = await fetchJSON(`/api/tasks/${currentTaskName}/run`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: 'null' });
          showNotification('âœ… åˆ†æä»»åŠ¡å·²å¯åŠ¨', 'success');
          if (runBtn) runBtn.textContent = 'â³ è¿è¡Œä¸­...';
          startPolling(res.run_id);
          updateStats();
        } catch (e) {
          showNotification('âŒ å¯åŠ¨å¤±è´¥: ' + (e.message || String(e)), 'error');
          if (runBtn) { runBtn.disabled = false; runBtn.textContent = 'ğŸš€ æ‰§è¡Œæ•°æ®åº“åˆ†æ'; }
        }
        return;
      }

      const dbType = document.getElementById('dbType').value;
      const host = document.getElementById('dbHost').value;
      const port = parseInt(document.getElementById('dbPort').value) || 3306;
      const database = document.getElementById('dbName').value;
      const user = document.getElementById('dbUser').value;
      const password = document.getElementById('dbPassword').value;
      const authSource = document.getElementById('dbAuthSource').value;

      // éªŒè¯å¿…å¡«å­—æ®µ
      if (!host) {
        showNotification('âŒ è¯·å¡«å†™ä¸»æœºåœ°å€', 'error');
        return;
      }
      
      // MySQL å’Œ PostgreSQL éœ€è¦ç”¨æˆ·åå’Œå¯†ç 
      if (dbType === 'mysql' || dbType === 'postgresql') {
        if (!user) {
          showNotification('âŒ è¯·å¡«å†™ç”¨æˆ·å', 'error');
          return;
        }
        if (!password) {
          showNotification('âŒ è¯·å¡«å†™å¯†ç ', 'error');
          return;
        }
      }
      
      // MongoDB å¦‚æœæä¾›äº†ç”¨æˆ·åï¼Œåˆ™éœ€è¦å¯†ç 
      if (dbType === 'mongodb' && user && !password) {
        showNotification('âŒ å¦‚æœæä¾›äº†ç”¨æˆ·åï¼Œåˆ™å¿…é¡»æä¾›å¯†ç ', 'error');
        return;
      }
      // å¼±å£ä»¤æ ¡éªŒï¼šç¬¦åˆç½‘å®‰è¦æ±‚ï¼Œä¸å…è®¸ä½¿ç”¨å¼±å£ä»¤è¿æ¥æ•°æ®åº“
      if ((dbType === 'mysql' || dbType === 'postgresql') && password && isWeakDbPassword(password)) {
        showNotification('âŒ ä¸ºç¬¦åˆå®‰å…¨ç­–ç•¥ï¼Œä¸å…è®¸ä½¿ç”¨å¼±å£ä»¤è¿æ¥æ•°æ®åº“ã€‚è¯·ä½¿ç”¨è‡³å°‘8ä½ã€å«å­—æ¯ä¸æ•°å­—çš„å¼ºå¯†ç ï¼›è‹¥æ— æ³•ä¿®æ”¹æ•°æ®åº“å¯†ç ï¼Œå¯è”ç³»ç½‘å®‰åšç™½åå•ã€‚', 'error');
        return;
      }
      if ((dbType === 'redis' || dbType === 'mongodb') && password && isWeakDbPassword(password)) {
        showNotification('âŒ ä¸ºç¬¦åˆå®‰å…¨ç­–ç•¥ï¼Œä¸å…è®¸ä½¿ç”¨å¼±å£ä»¤è¿æ¥æ•°æ®åº“ã€‚è¯·ä½¿ç”¨è‡³å°‘8ä½ã€å«å­—æ¯ä¸æ•°å­—çš„å¼ºå¯†ç ï¼›è‹¥æ— æ³•ä¿®æ”¹æ•°æ®åº“å¯†ç ï¼Œå¯è”ç³»ç½‘å®‰åšç™½åå•ã€‚', 'error');
        return;
      }

      // æ”¶é›†åˆ†æé€‰é¡¹
      const collectSlowQueries = document.getElementById('optSlowQueries').checked;
      const collectProcesslist = document.getElementById('optProcesslist').checked;
      const collectStatus = document.getElementById('optStatus').checked;
      const collectVariables = document.getElementById('optVariables').checked;
      const collectIndexes = document.getElementById('optIndexes').checked;
      const collectTables = document.getElementById('optTables').checked;

      // æ”¶é›†æ€§èƒ½ä¼˜åŒ–å‚æ•°
      const queryTimeout = parseInt(document.getElementById('queryTimeout').value) || 30;
      const tableLimit = parseInt(document.getElementById('tableLimit').value) || 1000;
      const indexLimit = parseInt(document.getElementById('indexLimit').value) || 5000;
      const slowQueryLimit = parseInt(document.getElementById('slowQueryLimit').value) || 100;
      const readOnlyMode = document.getElementById('optReadOnly').checked;
      const lowPriority = document.getElementById('optLowPriority').checked;

      // æ„å»ºé…ç½®å¯¹è±¡ï¼ˆæ ¹æ®æ•°æ®åº“ç±»å‹ï¼‰
      const dbConfig = {
        db_type: dbType,  // æ·»åŠ æ•°æ®åº“ç±»å‹æ ‡è¯†
        host: host,
        port: port,
        database: database || null
      };
      
      // åªæœ‰å½“å¯†ç ä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ 
      if (password) {
        dbConfig.password = password;
      }
      
      // MySQL å’Œ PostgreSQL éœ€è¦ç”¨æˆ·å
      if (dbType === 'mysql' || dbType === 'postgresql' || dbType === 'mongodb') {
        dbConfig.user = user;
      }
      
      // MongoDB éœ€è¦è®¤è¯æ•°æ®åº“
      if (dbType === 'mongodb' && authSource) {
        dbConfig.auth_source = authSource;
      }
      
      // Redis ä½¿ç”¨ database ä½œä¸ºæ•°æ®åº“ç¼–å·ï¼ˆ0-15ï¼‰ï¼ŒAPI è¦æ±‚ä¸ºå­—ç¬¦ä¸²
      if (dbType === 'redis') {
        dbConfig.database = String(parseInt(database, 10) || 0);
      }
      
      // é€šç”¨æ”¶é›†é€‰é¡¹ï¼ˆMySQL/PostgreSQLï¼‰
      if (dbType === 'mysql' || dbType === 'postgresql') {
        dbConfig.collect_slow_queries = collectSlowQueries;
        dbConfig.collect_processlist = collectProcesslist;
        dbConfig.collect_status = collectStatus;
        dbConfig.collect_variables = collectVariables;
        dbConfig.collect_indexes = collectIndexes;
        dbConfig.collect_tables = collectTables;
        dbConfig.slow_query_limit = slowQueryLimit;
        dbConfig.query_timeout = queryTimeout;
        dbConfig.read_only_mode = readOnlyMode;
        dbConfig.table_limit = tableLimit;
        dbConfig.index_limit = indexLimit;
        if (dbType === 'mysql') {
          dbConfig.low_priority = lowPriority;
        }
      }
      
      // Redis ç‰¹å®šé€‰é¡¹
      if (dbType === 'redis') {
        dbConfig.collect_info = collectStatus;
        dbConfig.collect_slowlog = collectSlowQueries;
        dbConfig.collect_clients = collectProcesslist;
        dbConfig.collect_memory = collectStatus;
        dbConfig.collect_keyspace = collectTables;
        dbConfig.collect_config = collectVariables;
        dbConfig.slowlog_limit = slowQueryLimit;
        dbConfig.socket_timeout = queryTimeout;
      }
      
      // MongoDB ç‰¹å®šé€‰é¡¹
      if (dbType === 'mongodb') {
        dbConfig.collect_server_status = collectStatus;
        dbConfig.collect_database_stats = collectTables;
        dbConfig.collect_collection_stats = collectTables;
        dbConfig.collect_indexes = collectIndexes;
        dbConfig.collect_operations = collectStatus;
        dbConfig.collect_connections = collectProcesslist;
        dbConfig.collection_limit = tableLimit;
        dbConfig.index_limit = indexLimit;
        dbConfig.socket_timeout_ms = queryTimeout * 1000;
      }
      
      // æ‰§è¡Œä»»åŠ¡
      const runBtn = document.getElementById('runAnalysisBtn');
      try {
        // ç¦ç”¨æ‰§è¡ŒæŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
        if (runBtn) {
          runBtn.disabled = true;
          runBtn.textContent = 'â³ å¯åŠ¨ä¸­...';
        }
        
        const res = await fetchJSON(`/api/tasks/${currentTaskName}/run`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(dbConfig)
        });
        
        showNotification('âœ… åˆ†æä»»åŠ¡å·²å¯åŠ¨', 'success');
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        if (runBtn) {
          runBtn.textContent = 'â³ è¿è¡Œä¸­...';
        }
        
        startPolling(res.run_id);
        updateStats();
      } catch (e) {
        showNotification('âŒ å¯åŠ¨å¤±è´¥: ' + e.message, 'error');
        // æ¢å¤æŒ‰é’®
        if (runBtn) {
          runBtn.disabled = false;
          runBtn.textContent = 'ğŸš€ æ‰§è¡Œæ•°æ®åº“åˆ†æ';
        }
      }
    }

    // è½®è¯¢ä»»åŠ¡çŠ¶æ€
    function startPolling(runId) {
      if (pollingInterval) clearInterval(pollingInterval);
      currentRunId = runId;
      
      const progressContainer = document.getElementById('progressContainer');
      progressContainer.style.display = 'block';
      
      pollingInterval = setInterval(async () => {
        try {
          const r = await fetchJSON(`/api/runs/${runId}`);
          updateProgress(r);
          
          if (r.status === 'completed' || r.status === 'failed') {
            clearInterval(pollingInterval);
            pollingInterval = null;
            
            if (r.status === 'completed') {
              showNotification('âœ… åˆ†æå®Œæˆï¼', 'success');
              if (usePageConfig()) {
                const dbType = document.getElementById('dbType').value;
                const host = document.getElementById('dbHost').value;
                const port = parseInt(document.getElementById('dbPort').value) || 3306;
                const database = document.getElementById('dbName').value;
                const user = document.getElementById('dbUser').value;
                const password = document.getElementById('dbPassword').value;
                addConnectionToHistory({ db_type: dbType, host, port, database: database || null, user: user || null, password: password || null, auth_source: dbType === 'mongodb' ? document.getElementById('dbAuthSource').value : null });
              }
              // æ¢å¤æŒ‰é’®
              const runBtn = document.getElementById('runAnalysisBtn');
              if (runBtn) {
                runBtn.disabled = false;
                runBtn.textContent = 'ğŸš€ æ‰§è¡Œæ•°æ®åº“åˆ†æ';
              }
              if (r.report_id) {
                setTimeout(() => viewReport(r.report_id), 1000);
              }
              loadReports();
              updateStats();
            } else if (r.status === 'failed') {
              let errorMsg = r.error || 'æœªçŸ¥é”™è¯¯';
              let shortErrorMsg = errorMsg.split('\n')[0];
              let showDetailedError = false;
              
              // æ”¹è¿›é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
              if (errorMsg.includes('æ— æ³•è¿æ¥åˆ°') || errorMsg.includes('è¿æ¥å¤±è´¥') || errorMsg.includes('ConnectionError') || errorMsg.includes('è¿æ¥è¢«æ‹’ç»')) {
                shortErrorMsg = 'âŒ æ•°æ®åº“è¿æ¥å¤±è´¥';
                showDetailedError = true;
                
                // æ„å»ºè¯¦ç»†çš„è§£å†³æ–¹æ¡ˆ
                let solution = 'æ•°æ®åº“è¿æ¥å¤±è´¥\n\né”™è¯¯è¯¦æƒ…ï¼š' + errorMsg;
                
                if (errorMsg.includes('localhost') || errorMsg.includes('127.0.0.1')) {
                  solution += '\n\nğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š\n';
                  solution += '1. å¦‚æœdb_ops_analyzerè¿è¡Œåœ¨Dockerå®¹å™¨ä¸­ï¼Œè¯·ä½¿ç”¨PostgreSQLå®¹å™¨çš„æœåŠ¡åç§°ï¼ˆå¦‚ windmill-db-1ï¼‰\n';
                  solution += '2. ç¡®ä¿ä¸¤ä¸ªå®¹å™¨åœ¨åŒä¸€ä¸ªDockerç½‘ç»œä¸­\n';
                  solution += '3. æ£€æŸ¥PostgreSQLæ˜¯å¦ç›‘å¬æ‰€æœ‰æ¥å£ï¼ˆlisten_addresses = \'*\')';
                } else if (errorMsg.includes('timeout') || errorMsg.includes('è¶…æ—¶')) {
                  solution += '\n\nğŸ’¡ å¯èƒ½çš„åŸå› ï¼š\n';
                  solution += '1. ç½‘ç»œä¸é€šæˆ–é˜²ç«å¢™é˜»æ­¢\n';
                  solution += '2. PostgreSQLæœåŠ¡æœªè¿è¡Œ\n';
                  solution += '3. ä¸»æœºåœ°å€æˆ–ç«¯å£ä¸æ­£ç¡®';
                }
                
                errorMsg = solution;
              }
              
              // æ˜¾ç¤ºç®€çŸ­é”™è¯¯ä¿¡æ¯
              showNotification(shortErrorMsg, 'error');
              
              // å¦‚æœé”™è¯¯ä¿¡æ¯è¾ƒé•¿ï¼Œæ˜¾ç¤ºè¯¦ç»†é”™è¯¯å¯¹è¯æ¡†
              if (showDetailedError || errorMsg.length > 100) {
                console.error('è¯¦ç»†é”™è¯¯ä¿¡æ¯:', errorMsg);
                setTimeout(() => {
                  // åˆ›å»ºä¸€ä¸ªæ›´å‹å¥½çš„é”™è¯¯æ˜¾ç¤º
                  const errorDiv = document.createElement('div');
                  errorDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e1e1e; border: 2px solid #ff4444; border-radius: 8px; padding: 20px; max-width: 600px; max-height: 80vh; overflow-y: auto; z-index: 10000; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';
                  errorDiv.innerHTML = `
                    <div style="color: #ff4444; font-size: 18px; font-weight: bold; margin-bottom: 15px;">âŒ æ•°æ®åº“è¿æ¥å¤±è´¥</div>
                    <div style="color: #ccc; white-space: pre-wrap; font-family: monospace; font-size: 13px; line-height: 1.6; margin-bottom: 15px;">${errorMsg}</div>
                    <button onclick="this.parentElement.remove()" style="background: #ff4444; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; float: right;">å…³é—­</button>
                    <div style="clear: both;"></div>
                  `;
                  document.body.appendChild(errorDiv);
                }, 500);
              }
              
              // æ¢å¤æŒ‰é’®
              const runBtn = document.getElementById('runAnalysisBtn');
              if (runBtn) {
                runBtn.disabled = false;
                runBtn.textContent = 'ğŸš€ æ‰§è¡Œæ•°æ®åº“åˆ†æ';
              }
            }
          }
        } catch (e) {
          console.error('è½®è¯¢å¤±è´¥:', e);
        }
      }, 2000);
    }

    // æ›´æ–°è¿›åº¦
    function updateProgress(run) {
      const stage = run.stage || 'queued';
      const progress = run.progress || {};
      const percentage = progress.percentage || 0;
      
      const stageMap = {
        'queued': 'â³ æ’é˜Ÿä¸­...',
        'collecting': 'ğŸ“¥ æ”¶é›†æ•°æ®åº“ä¿¡æ¯...',
        'analyzing': 'ğŸ§  AIåˆ†æä¸­...',
        'saving': 'ğŸ’¾ ä¿å­˜ç»“æœ...',
        'finished': 'âœ… å·²å®Œæˆ',
        'failed': 'âŒ å¤±è´¥'
      };
      
      document.getElementById('progressStage').textContent = stageMap[stage] || stage;
      document.getElementById('progressPercent').textContent = percentage + '%';
      document.getElementById('progressFill').style.width = percentage + '%';
      document.getElementById('progressDetail').textContent = 
        `çŠ¶æ€: ${stageMap[stage] || stage} | è¿›åº¦: ${percentage}%`;
    }

    // åŠ è½½æŠ¥å‘Šåˆ—è¡¨
    async function loadReports() {
      try {
        const limit = document.getElementById('reportLimit').value || '10';
        const url = `/api/reports?limit=${limit}`;
        const data = await fetchJSON(url);
        const reports = data.reports || [];
        
        const reportsList = document.getElementById('reportsList');
        
        if (reports.length === 0) {
          reportsList.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“‹</div>
              <div>æš‚æ— åˆ†ææŠ¥å‘Š</div>
            </div>
          `;
          return;
        }
        
        reportsList.innerHTML = reports.map(r => {
          const time = r.created_at ? r.created_at.replace('T', ' ').substring(0, 19) : '-';
          const taskName = r.task_name || 'æœªçŸ¥ä»»åŠ¡';
          
          return `
            <div class="report-card" onclick="viewReport('${r.id}')" data-id="${r.id}">
              <div class="report-card-header">
                <div class="report-id">${r.id}</div>
                <div class="report-time">${time}</div>
              </div>
              <div style="margin-top: 12px; font-weight: 600; color: var(--text);">
                ${taskName}
              </div>
              <div class="report-db-info">
                <span>ğŸ“Š åˆ†ææŠ¥å‘Š</span>
                <span>ğŸ—„ï¸ ${r.database || 'all'}</span>
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        document.getElementById('reportsList').innerHTML = 
          `<div style="color: var(--danger); padding: 20px;">é”™è¯¯: ${err.message}</div>`;
      }
    }

    // æŸ¥çœ‹æŠ¥å‘Š
    async function viewReport(reportId) {
      // é«˜äº®é€‰ä¸­çš„æŠ¥å‘Š
      document.querySelectorAll('.report-card').forEach(el => {
        el.classList.remove('active');
      });
      document.querySelector(`[data-id="${reportId}"]`)?.classList.add('active');
      
      // æ˜¾ç¤ºæŠ¥å‘ŠæŸ¥çœ‹å™¨
      document.getElementById('reportViewerCard').style.display = 'block';
      document.getElementById('reportViewerCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      document.getElementById('reportContent').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">â³ åŠ è½½ä¸­...</div>';
      
      try {
        const r = await fetch(`/api/reports/${reportId}`, { credentials: 'include' });
        if (!r.ok) throw new Error(await r.text());
        const text = await r.text();
        
        // ä¿å­˜åŸå§‹æ–‡æœ¬ç”¨äºå¤åˆ¶
        currentReportText = text;
        
        // ä½¿ç”¨ marked æ¸²æŸ“ Markdownï¼ˆæŠ¥å‘Šå†…å« HTML è¡¨æ ¼ï¼Œé¡»ä¿ç•™åŸå§‹ HTML ä¸è½¬ä¹‰ï¼‰
        if (typeof marked !== 'undefined') {
          marked.setOptions({
            breaks: false,
            gfm: true,
            headerIds: true,
            mangle: false,
            sanitize: false   // ä¸è½¬ä¹‰ HTMLï¼Œä½¿ <table> ç­‰èƒ½æ­£å¸¸æ¸²æŸ“
          });

          let html = marked.parse(text);
          // è‹¥æŸç‰ˆæœ¬ä»æŠŠ HTML è½¬ä¹‰æˆ &lt; &gt;ï¼Œåˆ™è¿˜åŸæŠ¥å‘Šé‡Œçš„è¡¨æ ¼æ ‡ç­¾
          if (html.includes('&lt;table') && html.includes('report-stats-table')) {
            html = html.replace(/&lt;(\/?(?:table|thead|tbody|tr|th|td)(?:\s[^&]*)?)&gt;/g, '<$1>');
          }

          html = enhanceReportHTML(html);
          document.getElementById('reportContent').innerHTML = html;
        } else {
          // é™çº§æ–¹æ¡ˆï¼šçº¯æ–‡æœ¬æ˜¾ç¤ºï¼Œä¿ç•™æ¢è¡Œ
          document.getElementById('reportContent').innerHTML = 
            '<pre style="white-space: pre-wrap; font-family: inherit; background: transparent; border: none; padding: 0; margin: 0;">' + 
            text.replace(/</g, '&lt;').replace(/>/g, '&gt;') + 
            '</pre>';
        }
      } catch (e) {
        document.getElementById('reportContent').innerHTML = 
          `<div style="color: var(--danger); padding: 20px;">é”™è¯¯: ${e.message}</div>`;
      }
    }
    
    // å¢å¼ºæŠ¥å‘ŠHTMLï¼Œæ·»åŠ å±‚æ¬¡å’Œé‡ç‚¹
    function enhanceReportHTML(html) {
      // åˆ›å»ºä¸´æ—¶å®¹å™¨
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      
      // å¤„ç†æ ‡é¢˜ï¼Œæ·»åŠ å›¾æ ‡å’Œæ ·å¼
      tempDiv.querySelectorAll('h1').forEach(h1 => {
        h1.style.cssText = 'font-size: 28px; font-weight: 700; margin: 30px 0 20px 0; padding-bottom: 15px; border-bottom: 3px solid var(--primary); color: var(--primary); display: flex; align-items: center; gap: 10px;';
        if (!h1.textContent.includes('ğŸ“Š')) {
          h1.innerHTML = 'ğŸ“Š ' + h1.innerHTML;
        }
      });
      
      tempDiv.querySelectorAll('h2').forEach(h2 => {
        h2.style.cssText = 'font-size: 22px; font-weight: 600; margin: 25px 0 15px 0; padding: 12px 0 8px 0; border-bottom: 2px solid var(--border); color: var(--text); display: flex; align-items: center; gap: 8px;';
        const text = h2.textContent.trim();
        if (text.includes('æ‰§è¡Œæ‘˜è¦') || text.includes('æ‘˜è¦')) {
          h2.innerHTML = 'ğŸ“‹ ' + h2.innerHTML;
        } else if (text.includes('æ€§èƒ½') || text.includes('Performance')) {
          h2.innerHTML = 'âš¡ ' + h2.innerHTML;
        } else if (text.includes('é…ç½®') || text.includes('Config')) {
          h2.innerHTML = 'âš™ï¸ ' + h2.innerHTML;
        } else if (text.includes('å®¹é‡') || text.includes('Capacity')) {
          h2.innerHTML = 'ğŸ’¾ ' + h2.innerHTML;
        } else if (text.includes('å®‰å…¨') || text.includes('Security')) {
          h2.innerHTML = 'ğŸ”’ ' + h2.innerHTML;
        } else if (text.includes('ä¼˜åŒ–') || text.includes('Optimization')) {
          h2.innerHTML = 'ğŸš€ ' + h2.innerHTML;
        } else if (text.includes('é”™è¯¯') || text.includes('Error')) {
          h2.innerHTML = 'âŒ ' + h2.innerHTML;
          h2.style.color = 'var(--danger)';
        } else if (text.includes('æ•°æ®ç»Ÿè®¡') || text.includes('Statistics')) {
          h2.innerHTML = 'ğŸ“ˆ ' + h2.innerHTML;
        } else {
          h2.innerHTML = 'ğŸ“Œ ' + h2.innerHTML;
        }
      });
      
      tempDiv.querySelectorAll('h3').forEach(h3 => {
        h3.style.cssText = 'font-size: 18px; font-weight: 600; margin: 20px 0 12px 0; color: var(--accent); padding-left: 10px; border-left: 4px solid var(--accent);';
      });
      
      tempDiv.querySelectorAll('h4').forEach(h4 => {
        h4.style.cssText = 'font-size: 16px; font-weight: 500; margin: 15px 0 10px 0; color: var(--text-muted);';
      });
      
      // å¤„ç†é‡è¦ä¿¡æ¯ï¼ˆåŒ…å«âš ï¸ã€âŒã€âœ…ç­‰emojiçš„æ®µè½ï¼‰
      tempDiv.querySelectorAll('p').forEach(p => {
        const text = p.textContent;
        // åŸºç¡€æ ·å¼ï¼šç¡®ä¿æ®µè½æœ‰åˆé€‚çš„é—´è·
        p.style.cssText = 'margin: 16px 0; line-height: 1.8; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%;';
        
        if (text.includes('âš ï¸') || text.includes('âŒ') || text.includes('é”™è¯¯') || text.includes('æ— æ•°æ®')) {
          p.style.cssText = 'background: rgba(239, 68, 68, 0.1); border-left: 4px solid var(--danger); padding: 12px 15px; margin: 16px 0; border-radius: 6px; color: var(--danger); font-weight: 500; line-height: 1.8;';
        } else if (text.includes('âœ…') || text.includes('æˆåŠŸ') || text.includes('æ­£å¸¸')) {
          p.style.cssText = 'background: rgba(16, 185, 129, 0.1); border-left: 4px solid var(--success); padding: 12px 15px; margin: 16px 0; border-radius: 6px; color: var(--success); font-weight: 500; line-height: 1.8;';
        } else if (text.includes('ğŸ’¡') || text.includes('æç¤º') || text.includes('å»ºè®®')) {
          p.style.cssText = 'background: rgba(14, 165, 233, 0.1); border-left: 4px solid var(--info); padding: 12px 15px; margin: 16px 0; border-radius: 6px; color: var(--info); line-height: 1.8;';
        }
      });
      
      // å¤„ç†ä»£ç å—
      tempDiv.querySelectorAll('pre').forEach(pre => {
        pre.style.cssText = 'background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; overflow-x: auto; margin: 15px 0;';
      });
      
      tempDiv.querySelectorAll('code').forEach(code => {
        if (code.parentElement.tagName !== 'PRE') {
          code.style.cssText = 'background: rgba(14, 165, 233, 0.2); padding: 2px 6px; border-radius: 4px; font-family: "Courier New", monospace; font-size: 0.9em; color: var(--accent);';
        } else {
          code.style.cssText = 'color: var(--text); font-family: "Courier New", monospace;';
        }
      });
      
      // å¤„ç†åˆ—è¡¨
      tempDiv.querySelectorAll('ul, ol').forEach(list => {
        list.style.cssText = 'margin: 15px 0; padding-left: 25px; line-height: 1.8; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%;';
      });
      
      tempDiv.querySelectorAll('li').forEach(li => {
        li.style.cssText = 'margin: 8px 0; color: var(--text); line-height: 1.8; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%;';
        // é«˜äº®é‡è¦åˆ—è¡¨é¡¹
        if (li.textContent.includes('Critical') || li.textContent.includes('ç´§æ€¥') || li.textContent.includes('é«˜ä¼˜å…ˆçº§')) {
          li.style.cssText += 'font-weight: 600; color: var(--danger);';
        } else if (li.textContent.includes('High') || li.textContent.includes('é«˜')) {
          li.style.cssText += 'font-weight: 500; color: var(--warning);';
        }
      });
      
      // å¤„ç†è¡¨æ ¼
      tempDiv.querySelectorAll('table').forEach(table => {
        table.style.cssText = 'width: 100%; border-collapse: collapse; margin: 20px 0; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; table-layout: auto; word-wrap: break-word; overflow-wrap: break-word;';
      });
      
      tempDiv.querySelectorAll('th').forEach(th => {
        th.style.cssText = 'background: var(--bg-card); padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border); color: var(--primary); word-wrap: break-word; overflow-wrap: break-word; max-width: 200px;';
      });
      
      tempDiv.querySelectorAll('td').forEach(td => {
        td.style.cssText = 'padding: 10px 12px; border-bottom: 1px solid var(--border); color: var(--text); word-wrap: break-word; overflow-wrap: break-word; max-width: 300px; line-height: 1.6;';
      });
      
      tempDiv.querySelectorAll('tr:last-child td').forEach(td => {
        td.style.borderBottom = 'none';
      });
      
      // å¤„ç†å¼•ç”¨å—
      tempDiv.querySelectorAll('blockquote').forEach(blockquote => {
        blockquote.style.cssText = 'border-left: 4px solid var(--primary); padding: 15px 20px; margin: 20px 0; background: rgba(14, 165, 233, 0.05); border-radius: 6px; color: var(--text-muted); font-style: italic;';
      });
      
      // å¤„ç†æ°´å¹³çº¿
      tempDiv.querySelectorAll('hr').forEach(hr => {
        hr.style.cssText = 'border: none; border-top: 2px solid var(--border); margin: 30px 0;';
      });
      
      return tempDiv.innerHTML;
    }

    // å…³é—­æŠ¥å‘Š
    function closeReport() {
      document.getElementById('reportViewerCard').style.display = 'none';
      document.querySelectorAll('.report-card').forEach(el => {
        el.classList.remove('active');
      });
    }

    // å¤åˆ¶æŠ¥å‘Š - ä¿å­˜åŸå§‹æ–‡æœ¬ä»¥ä¾¿å¤åˆ¶
    let currentReportText = '';
    
    // å¤åˆ¶æŠ¥å‘Š
    function copyReport() {
      if (!currentReportText) {
        const content = document.getElementById('reportContent');
        if (!content) {
          showNotification('âŒ æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹', 'error');
          return;
        }
        // å°è¯•ä»HTMLä¸­æå–æ–‡æœ¬ï¼Œä¿ç•™æ¢è¡Œ
        currentReportText = content.innerText || content.textContent;
      }
      
      // ä½¿ç”¨ç°ä»£APIå¤åˆ¶
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(currentReportText).then(() => {
          showNotification('âœ… æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch((err) => {
          // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
          fallbackCopyTextToClipboard(currentReportText);
        });
      } else {
        // é™çº§æ–¹æ¡ˆ
        fallbackCopyTextToClipboard(currentReportText);
      }
    }
    
    // é™çº§å¤åˆ¶æ–¹æ¡ˆ
    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showNotification('âœ… æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        } else {
          showNotification('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶', 'error');
        }
      } catch (err) {
        showNotification('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶', 'error');
      }
      document.body.removeChild(textArea);
    }

    // åˆ·æ–°æ‰€æœ‰
    function refreshAll() {
      checkHealth();
      loadReports();
      updateStats();
      showNotification('ğŸ”„ å·²åˆ·æ–°', 'success');
    }

    // åŠ è½½ä»»åŠ¡åˆ—è¡¨ï¼ˆå«è¿æ¥æ‘˜è¦ï¼Œç”¨äºä»…ç”¨ config æ—¶å±•ç¤ºï¼‰
    async function loadTasks() {
      try {
        const res = await fetchJSON('/api/tasks');
        tasksList = res.tasks || [];
        const taskSelect = document.getElementById('taskSelect');
        if (taskSelect) {
          taskSelect.innerHTML = '';
          tasksList.forEach(task => {
            const opt = document.createElement('option');
            opt.value = task.name;
            opt.textContent = task.name + (task.description ? ` - ${task.description}` : '');
            taskSelect.appendChild(opt);
          });
          if (tasksList.length > 0) {
            currentTaskName = tasksList[0].name;
            taskSelect.value = currentTaskName;
            onTaskSelectChange();
          }
        }
      } catch (e) {
        console.error('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', e);
      }
    }

    function usePageConfig() {
      const section = document.getElementById('connectionFormSection');
      return section && section.style.display !== 'none' && document.getElementById('dbHost').value.trim();
    }

    // é¡µé¢åŠ è½½æ—¶å…ˆæ£€æŸ¥ç™»å½•æ€ï¼Œé€šè¿‡åˆ™æ˜¾ç¤ºä¸»åº”ç”¨å¹¶åˆå§‹åŒ–
    checkAuth();
  </script>
</body>
</html>
