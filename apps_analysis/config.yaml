# Log Analyzer é…ç½®æ–‡ä»¶
# è‡ªåŠ¨åŒ–è°ƒç”¨å¤§æ¨¡å‹è¿›è¡Œè¿ç»´å·¡æŸ¥

# æœåŠ¡å™¨é…ç½®
server:
  host: "0.0.0.0"
  port: 8000  # å®¹å™¨å†…ç«¯å£8000

# è‡ªåŠ¨ç›‘æ§é…ç½®ï¼ˆæ™ºèƒ½è¿ç»´åŠ©æ‰‹æ¨¡å¼ï¼‰
monitoring:
  enabled: true  # æ˜¯å¦å¯ç”¨è‡ªåŠ¨ç›‘æ§
  report_interval: 86400  # æŠ¥å‘Šç”Ÿæˆé—´éš”ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤86400ç§’ï¼ˆ1å¤©ï¼‰
  containers:  # è¦ç›‘æ§çš„å®¹å™¨åˆ—è¡¨ï¼ˆä¸ºç©ºåˆ™ä»ä»»åŠ¡é…ç½®ä¸­è‡ªåŠ¨è·å–ï¼‰
    - "dispatcher"
    - "agent_python"
    - "mcp_server"
  # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ–°å®¹å™¨ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç›‘æ§
  # - "æ–°å®¹å™¨å"
  hours_ago: 24  # æ¯æ¬¡ç”ŸæˆæŠ¥å‘Šæ—¶ï¼Œåˆ†ææœ€è¿‘Nå°æ—¶çš„æ—¥å¿—ï¼ˆé»˜è®¤24å°æ—¶ï¼‰
  report_hour: 2  # æ¯å¤©ç”ŸæˆæŠ¥å‘Šçš„æ—¶é—´ï¼ˆå°æ—¶ï¼Œ0-23ï¼‰ï¼Œé»˜è®¤å‡Œæ™¨2ç‚¹

# æ•°æ®åº“é…ç½®ï¼ˆå¯é€‰ï¼‰
database:
  # å¯ä»¥é…ç½®SQLiteã€PostgreSQLç­‰
  # type: "sqlite"
  # path: "data/analyzer.db"

# ä»»åŠ¡é…ç½®
tasks:
  # ç¤ºä¾‹: åº”ç”¨é”™è¯¯æ—¥å¿—åˆ†æ
  - name: "Apps_Error_Analysis"
    source:
      name: "multi"  # ä½¿ç”¨ MultiSource æ’ä»¶
      params:
        sources:
          # dispatcher åº”ç”¨é”™è¯¯æ—¥å¿—
          - type: "docker"
            container_name: "dispatcher"
            hours_ago: 72  # åˆ†ææœ€è¿‘72å°æ—¶ï¼ˆ3å¤©ï¼‰
            tail: 2000  # é™åˆ¶æ—¥å¿—è¡Œæ•°ï¼Œæå‡æ”¶é›†é€Ÿåº¦
            enable_pre_filter: true # å¯ç”¨æ—¥å¿—é¢„è¿‡æ»¤
            label: "dispatcher"
          
          # agent-python åº”ç”¨é”™è¯¯æ—¥å¿—
          - type: "docker"
            container_name: "agent_python"
            hours_ago: 72  # åˆ†ææœ€è¿‘72å°æ—¶ï¼ˆ3å¤©ï¼‰
            tail: 2000  # é™åˆ¶æ—¥å¿—è¡Œæ•°ï¼Œæå‡æ”¶é›†é€Ÿåº¦
            enable_pre_filter: true # å¯ç”¨æ—¥å¿—é¢„è¿‡æ»¤
            label: "agent-python"
          
          # mcp-server åº”ç”¨é”™è¯¯æ—¥å¿—
          - type: "docker"
            container_name: "mcp_server"
            hours_ago: 72  # åˆ†ææœ€è¿‘72å°æ—¶ï¼ˆ3å¤©ï¼‰
            tail: 2000  # é™åˆ¶æ—¥å¿—è¡Œæ•°ï¼Œæå‡æ”¶é›†é€Ÿåº¦
            enable_pre_filter: true # å¯ç”¨æ—¥å¿—é¢„è¿‡æ»¤
            label: "mcp-server"
        
        # å¯é€‰ï¼šå®šä¹‰è°ƒç”¨å…³ç³»ï¼ˆå¸®åŠ©å¤§æ¨¡å‹ç†è§£åº”ç”¨é—´å…³ç³»ï¼‰
        call_chain:
          - from: "dispatcher"
            to: "agent-python"
            protocol: "HTTP SSE"
          - from: "agent-python"
            to: "mcp-server"
            protocol: "MCP"
    
    analyzer:
      name: "langgraph"
      params:
        mode: "concurrent"  # å¹¶å‘åˆ†æï¼Œæå‡é€Ÿåº¦
        concurrency: 12  # å¢åŠ å¹¶å‘æ•°ï¼Œæå‡åˆ†æé€Ÿåº¦
        chunk_size: 2000  # å‡å°åˆ†å—å¤§å°ï¼Œæ¯ä¸ªå—åˆ†ææ›´å¿«
        timeout: 30  # LLMè°ƒç”¨è¶…æ—¶æ—¶é—´ï¼Œå‡å°‘ç­‰å¾…
        # LLM APIé…ç½®
        base_url: "http://10.163.25.156:5024/v1"
        api_key: "zhipu2025ddh"
        model_name: "external-ds-v3_2"
        # å¢å¼ºçš„æç¤ºè¯ï¼ˆåŒ…å«é”™è¯¯å…³è”åˆ†æå’Œä¿®å¤å»ºè®®ï¼‰
        prompts:
          analyze_log_chunk: |
            # é”™è¯¯æ—¥å¿—åˆ†æä»»åŠ¡
            
            **ä»»åŠ¡**: å¿«é€Ÿè¯†åˆ«æ—¥å¿—ä¸­çš„é”™è¯¯ã€å¼‚å¸¸å’Œè­¦å‘Š
            
            ## åˆ†æè¦æ±‚
            1. åªè¯†åˆ«**çœŸæ­£çš„é”™è¯¯**ï¼ˆErrorã€Exceptionã€Fatalã€Failedç­‰ï¼‰
            2. å¿½ç•¥æ­£å¸¸æ—¥å¿—ã€INFOçº§åˆ«æ—¥å¿—ã€ä¸šåŠ¡æ•°æ®è¾“å‡º
            3. å¦‚æœ**æœªå‘ç°ä»»ä½•é”™è¯¯**ï¼Œè¯·ä»…å›å¤ "<NONE>"
            
            ## è¾“å‡ºæ ¼å¼ï¼ˆå¦‚æœå‘ç°é”™è¯¯ï¼‰
            ```
            åº”ç”¨: [åº”ç”¨åç§°]
            ç±»å‹: [ç½‘ç»œé”™è¯¯/æ–‡ä»¶é”™è¯¯/ä¸šåŠ¡é”™è¯¯/å…¶ä»–]
            ä¸¥é‡ç¨‹åº¦: [Critical/High/Medium/Low]
            é”™è¯¯: [é”™è¯¯æ¶ˆæ¯çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œä¸è¦å®Œæ•´å †æ ˆ]
            æ—¶é—´: [é”™è¯¯å‘ç”Ÿæ—¶é—´]
            ```
            
            **æ³¨æ„**: 
            - å¦‚æœæ—¥å¿—åªæ˜¯æ­£å¸¸çš„æ•°æ®è¾“å‡ºæˆ–INFOæ—¥å¿—ï¼Œå›å¤ "<NONE>"
            - ä¸è¦é‡å¤åˆ†æç›¸åŒçš„é”™è¯¯
            - è¾“å‡ºè¦ç®€æ´ï¼Œä¸è¦åŒ…å«å®Œæ•´çš„å †æ ˆè·Ÿè¸ª
            
            ## å¾…åˆ†ææ—¥å¿—ç‰‡æ®µ
            {log_chunk}
          
          summarize_analyses: |
            # é”™è¯¯æ—¥å¿—æ±‡æ€»åˆ†æ
            
            **æ±‡æ€»æ—¶é—´**: {current_time}
            
            ## ä»»åŠ¡è¦æ±‚
            è¯·å°†ä»¥ä¸‹é”™è¯¯åˆ†æç»“æœæ•´åˆä¸º**ç®€æ´ã€å®ç”¨**çš„æ‰§è¡Œæ‘˜è¦ã€‚è¦æ±‚ï¼š
            
            1. **å»é‡**: åˆå¹¶ç›¸åŒæˆ–ç›¸ä¼¼çš„é”™è¯¯ï¼Œåªä¿ç•™å…³é”®ä¿¡æ¯
            2. **ç»Ÿè®¡**: ç»Ÿè®¡é”™è¯¯ç±»å‹ã€åº”ç”¨åˆ†å¸ƒã€ä¸¥é‡ç¨‹åº¦åˆ†å¸ƒ
            3. **æ ¹å› **: è¯†åˆ«æ ¹æœ¬åŸå› ï¼ˆä¸è¦é‡å¤æè¿°ç°è±¡ï¼‰
            4. **å»ºè®®**: ç»™å‡º**å¯æ‰§è¡Œ**çš„ä¿®å¤å»ºè®®ï¼ˆä¸è¦ç©ºæ³›çš„æè¿°ï¼‰
            
            ## è¾“å‡ºæ ¼å¼ï¼ˆå¿…é¡»ä¸¥æ ¼éµå¾ªï¼‰
            
            ```markdown
            # é”™è¯¯æ—¥å¿—åˆ†ææŠ¥å‘Š
            
            ## ğŸ“Š é”™è¯¯ç»Ÿè®¡
            - æ€»é”™è¯¯æ•°: X
            - ä¸¥é‡é”™è¯¯(Critical): X
            - é«˜ä¼˜å…ˆçº§(High): X
            - ä¸­ä¼˜å…ˆçº§(Medium): X
            - ä½ä¼˜å…ˆçº§(Low): X
            
            ## ğŸ” é”™è¯¯åˆ†ç±»
            - ç½‘ç»œé”™è¯¯: Xæ¬¡
            - æ–‡ä»¶ç³»ç»Ÿé”™è¯¯: Xæ¬¡
            - ä¸šåŠ¡é”™è¯¯: Xæ¬¡
            - å…¶ä»–: Xæ¬¡
            
            ## ğŸ“± åº”ç”¨åˆ†å¸ƒ
            - dispatcher: Xä¸ªé”™è¯¯
            - agent-python: Xä¸ªé”™è¯¯
            - mcp-server: Xä¸ªé”™è¯¯
            
            ## ğŸ¯ å…³é”®é”™è¯¯ï¼ˆä»…åˆ—å‡ºæœ€é‡è¦çš„3-5ä¸ªï¼‰
            1. **[é”™è¯¯ç±»å‹]** - [åº”ç”¨åç§°]
               - é”™è¯¯: [ç®€è¦æè¿°]
               - å½±å“: [å½±å“èŒƒå›´]
               - æ—¶é—´: [å‘ç”Ÿæ—¶é—´]
            
            ## ğŸ”— æ ¹å› åˆ†æ
            [åˆ†æé”™è¯¯çš„æ ¹æœ¬åŸå› ï¼Œä¸è¦é‡å¤æè¿°ç°è±¡]
            
            ## ğŸ”§ ä¿®å¤å»ºè®®ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
            1. **[é«˜ä¼˜å…ˆçº§]** [å…·ä½“å¯æ‰§è¡Œçš„ä¿®å¤æ­¥éª¤]
            2. **[ä¸­ä¼˜å…ˆçº§]** [å…·ä½“å¯æ‰§è¡Œçš„ä¿®å¤æ­¥éª¤]
            3. **[ä½ä¼˜å…ˆçº§]** [å…·ä½“å¯æ‰§è¡Œçš„ä¿®å¤æ­¥éª¤]
            
            ## ğŸ’¡ æ€»ç»“
            [1-2å¥è¯æ€»ç»“æ ¸å¿ƒé—®é¢˜å’Œå»ºè®®]
            ```
            
            **é‡è¦**: 
            - ä¸è¦è¾“å‡ºåŸå§‹çš„é”™è¯¯åˆ†æå†…å®¹
            - åªè¾“å‡ºæ±‡æ€»åçš„ç»Ÿè®¡å’Œå…³é”®ä¿¡æ¯
            - ä¿®å¤å»ºè®®å¿…é¡»å…·ä½“ã€å¯æ‰§è¡Œ
            - æ€»é•¿åº¦æ§åˆ¶åœ¨500å­—ä»¥å†…
            
            ## å„åº”ç”¨é”™è¯¯åˆ†æç»“æœ
            {analyses}
    
    sinks:
      - name: "database"      # å­˜å…¥æ•°æ®åº“
      - name: "file"          # ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶
        params:
          output_path: "reports/{container_name}_{timestamp}.md"
      - name: "minio"         # ä¸Šä¼ åˆ° MinIOï¼ˆé•¿æœŸå½’æ¡£ï¼‰
        params:
          endpoint: "10.163.25.156:9300"
          access_key: "minioSuperAdmin"
          secret_key: "dwi&fea@faf*dfa"
          bucket_name: "log-analysis"
          object_prefix: "åº”ç”¨æ—¥å¿—æŠ¥å‘Š/"
          secure: false

  # ç¤ºä¾‹: å•åº”ç”¨æ–‡ä»¶æ—¥å¿—åˆ†æ
  - name: "File_Log_Analysis"
    source:
      name: "file"
      params:
        file_path: "logs/app.log"
        encoding: "utf-8"
    
    analyzer:
      name: "langgraph"
      params:
        mode: "concurrent"
        concurrency: 8
        chunk_size: 3000
        base_url: "http://10.163.25.156:5024/v1"
        api_key: "zhipu2025ddh"
        model_name: "external-ds-v3_2"
    
    sinks:
      - name: "file"
        params:
          output_path: "reports/{container_name}_{timestamp}.md"

  # ç¤ºä¾‹: æŸ¥çœ‹æœ€è¿‘7å¤©çš„æ—¥å¿—ï¼ˆé•¿æœŸåˆ†æï¼‰
  - name: "Long_Term_Analysis_7days"
    source:
      name: "multi"
      params:
        sources:
          - type: "docker"
            container_name: "dispatcher"
            hours_ago: 168  # æœ€è¿‘7å¤©ï¼ˆ168å°æ—¶ï¼‰
            label: "dispatcher"
          - type: "docker"
            container_name: "agent_python"
            hours_ago: 168
            label: "agent-python"
          - type: "docker"
            container_name: "mcp_server"
            hours_ago: 168
            label: "mcp-server"
    
    analyzer:
      name: "langgraph"
      params:
        mode: "concurrent"  # å¹¶å‘åˆ†æï¼Œæå‡é€Ÿåº¦
        concurrency: 8  # å¢åŠ å¹¶å‘æ•°
        chunk_size: 3000  # å‡å°åˆ†å—å¤§å°
        base_url: "http://10.163.25.156:5024/v1"
        api_key: "zhipu2025ddh"
        model_name: "external-ds-v3_2"
    
    sinks:
      - name: "file"
        params:
          output_path: "reports/{container_name}_é•¿æœŸåˆ†æ_{timestamp}.md"
      - name: "minio"
        params:
          endpoint: "10.163.25.156:9300"
          access_key: "minioSuperAdmin"
          secret_key: "dwi&fea@faf*dfa"
          bucket_name: "log-analysis"
          object_prefix: "long-term-reports/"
          secure: false

  # ç¤ºä¾‹: å¿«é€Ÿæ£€æŸ¥æœ€è¿‘10åˆ†é’Ÿçš„é”™è¯¯ï¼ˆå¯é€šè¿‡APIåŠ¨æ€æŒ‡å®šæ—¶é—´ï¼‰
  - name: "Quick_Check_10min"
    source:
      name: "multi"
      params:
        sources:
          - type: "docker"
            container_name: "dispatcher"
            minutes_ago: 10  # æœ€è¿‘10åˆ†é’Ÿ
            label: "dispatcher"
          - type: "docker"
            container_name: "agent_python"
            minutes_ago: 10
            label: "agent-python"
          - type: "docker"
            container_name: "mcp_server"
            minutes_ago: 10
            label: "mcp-server"
    
    analyzer:
      name: "langgraph"
      params:
        mode: "concurrent"  # å¹¶å‘åˆ†æï¼Œæå‡é€Ÿåº¦
        concurrency: 8  # å¢åŠ å¹¶å‘æ•°
        chunk_size: 3000  # å‡å°åˆ†å—å¤§å°
        base_url: "http://10.163.25.156:5024/v1"
        api_key: "zhipu2025ddh"
        model_name: "external-ds-v3_2"
    
    sinks:
      - name: "file"
        params:
          output_path: "reports/{container_name}_å¿«é€Ÿæ£€æŸ¥_{timestamp}.md"
